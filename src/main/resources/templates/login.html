<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="/css/login.css" />
</head>
<body style="margin: 0">
  <div class="container-center-horizontal">
    <div class="sign-in-screen screen">
      <div class="main-dashboard">
        <div class="inputs">
          <div class="title">
            <div class="text-21">로그인</div>
          </div>

          <form action="login.do" method="post" id="loginForm" onsubmit="return handleLogin()">
            <div class="input-group">
              <label for="userId" class="text-1">아이디</label>
              <input type="text" id="userId" name="id" class="input-field-text" placeholder="아이디를 입력하세요" required />
            </div>

            <div class="input-group">
              <label for="password" class="text-1">비밀번호</label>
              <input type="password" id="password" name="pw" class="input-field-text" placeholder="비밀번호를 입력하세요" required />
            </div>

            <!-- 🔹 자동 로그인 스위치 추가 -->
            <div class="remember-me">
              <label class="switch-base">
                <input type="checkbox" id="autoLoginToggle" name="autoLogin" />
                <div class="ellipse-1"></div>
              </label>
              <div class="text-15"> 자동 로그인</div>
            </div>

            <div class="button-base_login">
              <button type="submit" id="loginBtn" class="button-body">
                <div class="text">로그인</div>
              </button>
            </div>
          </form>

          <div class="text-14">
            계정이 없으신가요? <a href="register" class="signup-link">회원가입</a> <br>
            30일 내 탈퇴한 계정이 있으신가요? <a href="relogin" class="signup-link">계정복구</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**
   * 🔹 로그인 시 SHA-256 암호화 후 전송
   * - 자동 로그인 선택 시 LocalStorage에 ID/PW 저장 (암호화된 비밀번호)
   */
   async function handleLogin() {
	    let userId = document.getElementById("userId").value;
	    let password = document.getElementById("password").value;
	    let autoLogin = document.getElementById("autoLoginToggle").checked;

	    if (userId === "" || password === "") {
	        alert("아이디와 비밀번호를 입력하세요.");
	        return false;
	    }

	    // SHA-256 암호화
	    let encryptedPw = await encryptSHA256(password);
	    console.log("🔒 암호화된 PW:", encryptedPw);

	    // 자동 로그인 시 LocalStorage 저장 (암호화된 PW 저장)
	    if (autoLogin) {
	        localStorage.setItem("autoLogin", "true");
	        localStorage.setItem("savedUserId", userId);
	        localStorage.setItem("savedPassword", encryptedPw); // ✅ 암호화된 비밀번호 저장
	    } else {
	        localStorage.removeItem("autoLogin");
	        localStorage.removeItem("savedUserId");
	        localStorage.removeItem("savedPassword");
	    }

	    // 서버로 암호화된 비밀번호 전송
	    document.getElementById("password").value = encryptedPw;
	    return true; // 폼 제출 진행
	}



    /**
     * 🔹 SHA-256 암호화 함수
     * - 입력된 문자열을 SHA-256으로 해싱
     */
    async function encryptSHA256(text) {
      const encoder = new TextEncoder();
      const data = encoder.encode(text);
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    /**
     * 🔹 자동 로그인 확인 및 적용
     * - LocalStorage에서 저장된 ID/PW 불러와 자동 로그인 수행
     */
     window.onload = async function () {
    	    let autoLogin = localStorage.getItem("autoLogin");

    	    if (autoLogin === "true") {
    	        let savedId = localStorage.getItem("savedUserId");
    	        let savedPw = localStorage.getItem("savedPassword"); // ✅ 이미 암호화된 비밀번호 가져오기

    	        if (savedId && savedPw) {
    	            console.log("🚀 자동 로그인 시도...");

    	            let response = await fetch("/api/auto-login", {
    	                method: "POST",
    	                headers: { "Content-Type": "application/json" },
    	                body: JSON.stringify({ id: savedId, pw: savedPw }) // ✅ 암호화된 PW 그대로 전송
    	            });

    	            let result = await response.text();
    	            if (result === "SUCCESS") {
    	                console.log("✅ 자동 로그인 성공");
    	                alert("자동 로그인 완료!");
    	                window.location.href = "/dashboard";
    	            } else {
    	                console.log("❌ 자동 로그인 실패");
    	                alert("자동 로그인 실패! 다시 로그인하세요.");
    	                localStorage.removeItem("autoLogin");
    	                localStorage.removeItem("savedUserId");
    	                localStorage.removeItem("savedPassword");
    	            }
    	        }
    	    }
    	};


  </script>
</body>
</html>
