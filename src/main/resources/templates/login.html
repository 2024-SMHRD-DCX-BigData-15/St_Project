<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="/css/login.css" />
</head>
<body style="margin: 0">
  <div class="container-center-horizontal">
    <div class="sign-in-screen screen">
      <div class="main-dashboard">
        <div class="inputs">
          <div class="title">
            <div class="text-21">๋ก๊ทธ์ธ</div>
          </div>

          <form action="/member/login.do" method="post" id="loginForm" onsubmit="return handleLogin()">
            <div class="input-group">
              <label for="userId" class="text-1">์์ด๋</label>
              <input type="text" id="userId" name="id" class="input-field-text" placeholder="์์ด๋๋ฅผ ์๋ฅํ์ธ์" required />
            </div>

            <div class="input-group">
              <label for="password" class="text-1">๋น๋ฐ๋ฒํธ</label>
              <input type="password" id="password" name="pw" class="input-field-text" placeholder="๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํ์ธ์" required />
            </div>

            <!-- ๐น ์๋ ๋ก๊ทธ์ธ ์ค์์น ์ถ๊ฐ -->
            <div class="remember-me">
              <label class="switch-base">
                <input type="checkbox" id="autoLoginToggle" name="autoLogin" />
                <div class="ellipse-1"></div>
              </label>
              <div class="text-15"> ์๋ ๋ก๊ทธ์ธ</div>
            </div>

            <div class="button-base_login">
              <button type="submit" id="loginBtn" class="button-body">
                <div class="text">๋ก๊ทธ์ธ</div>
              </button>
            </div>
          </form>

          <div class="text-14">
            ๊ณ์์ด ์์ผ์๊ฐ์? <a href="/register" class="signup-link">ํ์๊ฐ์</a> <br>
            30์ผ ๋ด ํํดํ ๊ณ์์ด ์์ผ์๊ฐ์? <a href="relogin" class="signup-link">๊ณ์๋ณต๊ตฌ</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**
   * ์ค์์น ๋ฐฐ๊ฒฝ์ ๋ณ๊ฒฝ
   */
  document.addEventListener("DOMContentLoaded", function () {
      const toggle = document.getElementById("autoLoginToggle");
      const switchBase = document.querySelector(".switch-base");

      // ์ด๊ธฐ ์ํ ์ค์
      if (toggle.checked) {
          switchBase.style.backgroundColor = "#0075ff";
      } else {
          switchBase.style.backgroundColor = "#ccc";
      }

      // ์ฒดํฌ ์ํ ๋ณ๊ฒฝ ์ ๋ฐฐ๊ฒฝ์ ์๋ฐ์ดํธ
      toggle.addEventListener("change", function () {
          if (toggle.checked) {
              switchBase.style.backgroundColor = "#0075ff";
          } else {
              switchBase.style.backgroundColor = "#ccc";
          }
      });
  });
  
//------------------- [ ๋ก๊ทธ์ธ ์คํจ ์๋์ฐฝ ๋ฐฑ์๋ ์คํฌ๋ฆฝํธ ] -------------------
  document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get("error");

      if (error === "invalid") {
          alert("๋ก๊ทธ์ธ ์คํจ: ์์ด๋ ๋๋ ๋น๋ฐ๋ฒํธ๊ฐ ์ผ์นํ์ง ์์ต๋๋ค.");
      }
  });
  
//------------------- [ ์๋๋ก๊ทธ์ธ ๋ฐฑ์๋ ์คํฌ๋ฆฝํธ ] -------------------
// ๐น ๋ก๊ทธ์ธ ์ฑ๊ณต ํ localStorage์ ์์ฅ
document.addEventListener("DOMContentLoaded", function () {
    const storedToken = localStorage.getItem("authToken");

    // โ ์๋ ๋ก๊ทธ์ธ ์๋ (๋ฌดํ ๋ฃจํ ๋ฐฉ์ง)
    if (storedToken && !sessionStorage.getItem("autoLoginAttempted")) {
        sessionStorage.setItem("autoLoginAttempted", "true"); // ๐จ ํ ๋ฒ๋ง ์คํ๋๋๋ก ์ค์

        fetch("/api/member/autoLogin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: storedToken }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("โ ์๋ ๋ก๊ทธ์ธ ์ฑ๊ณต:", data);
                window.location.href = "/maindashboard";
            } else {
                console.warn("๐จ ์๋ ๋ก๊ทธ์ธ ์คํจ: ํํฐ ๋ฌดํจ");
                localStorage.removeItem("authToken");
                sessionStorage.removeItem("autoLoginAttempted"); // ๐น ์คํจ ์ ๋ค์ ์๋ ๊ฐ๋ฅํ๋๋ก ์ค์
            }
        })
        .catch(error => console.error("๐จ ์๋ ๋ก๊ทธ์ธ ์ค๋ฅ:", error));
    }

    // ๐น ๋ก๊ทธ์ธ ๋ฒํผ ํด๋ฆญ ์ ์คํ
    document.getElementById("loginForm").addEventListener("submit", function (event) {
        event.preventDefault();

        const userId = document.getElementById("userId").value;
        const password = document.getElementById("password").value;
        const autoLogin = autoLoginToggle.checked; // ์๋ ๋ก๊ทธ์ธ ์ฌ๋ถ ํ์ธ

        fetch("/api/member/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: userId, pw: password, autoLogin }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log("โ ๋ก๊ทธ์ธ ์ฑ๊ณต:", data);

                // ๐น ์๋ ๋ก๊ทธ์ธ ์ฒดํฌ๋ ๊ฒฝ์ฐ ํํฐ ์์ฅ
                if (autoLogin && data.token) {
                    localStorage.setItem("authToken", data.token);
                }

                window.location.href = "/maindashboard"; // โ ๋ก๊ทธ์ธ ์ฑ๊ณต ์ ๋์๋ณด๋ ์ด๋
            } else {
                alert("๐จ ๋ก๊ทธ์ธ ์คํจ: " + data.message);
            }
        })
        .catch(error => console.error("๐จ ๋ก๊ทธ์ธ ์ค๋ฅ:", error));
    });
});

// ๐น ๋ก๊ทธ์์ ์ ํํฐ ์ญ์
function handleLogout() {
    console.log("๐ ๋ก๊ทธ์์ ์์ฒญ");

    // โ localStorage์์ ํํฐ ์ญ์
    localStorage.removeItem("authToken");

    // ์๋ฒ์ ๋ก๊ทธ์์ ์์ฒญ
    fetch("/api/member/logout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: localStorage.getItem("authToken") }),
    })
    .then(() => {
        alert("โ ๋ก๊ทธ์์ ์๋ฃ!");
        window.location.href = "/login";
    });
}

  </script>
</body>
</html>
