<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="/css/login.css" />
</head>
<body style="margin: 0">
  <div class="container-center-horizontal">
    <div class="sign-in-screen screen">
      <div class="main-dashboard">
        <div class="inputs">
          <div class="title">
            <div class="text-21">๋ก๊ทธ์ธ</div>
          </div>

          <form action="login.do" method="post" id="loginForm" onsubmit="return handleLogin()">
            <div class="input-group">
              <label for="userId" class="text-1">์์ด๋</label>
              <input type="text" id="userId" name="id" class="input-field-text" placeholder="์์ด๋๋ฅผ ์๋ฅํ์ธ์" required />
            </div>

            <div class="input-group">
              <label for="password" class="text-1">๋น๋ฐ๋ฒํธ</label>
              <input type="password" id="password" name="pw" class="input-field-text" placeholder="๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํ์ธ์" required />
            </div>

            <!-- ๐น ์๋ ๋ก๊ทธ์ธ ์ค์์น ์ถ๊ฐ -->
            <div class="remember-me">
              <label class="switch-base">
                <input type="checkbox" id="autoLoginToggle" name="autoLogin" />
                <div class="ellipse-1"></div>
              </label>
              <div class="text-15"> ์๋ ๋ก๊ทธ์ธ</div>
            </div>

            <div class="button-base_login">
              <button type="submit" id="loginBtn" class="button-body">
                <div class="text">๋ก๊ทธ์ธ</div>
              </button>
            </div>
          </form>

          <div class="text-14">
            ๊ณ์์ด ์์ผ์๊ฐ์? <a href="register" class="signup-link">ํ์๊ฐ์</a> <br>
            30์ผ ๋ด ํํดํ ๊ณ์์ด ์์ผ์๊ฐ์? <a href="relogin" class="signup-link">๊ณ์๋ณต๊ตฌ</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**
   * ๐น ๋ก๊ทธ์ธ ์ ์๋ฒ๋ก ํ๋ฌธ ๋น๋ฐ๋ฒํธ ์์ก (์๋ฒ์์ SHA-256 ์ํธํ)
   * - ์๋ ๋ก๊ทธ์ธ ์ํ ์ ์ฟํค์ ID/PW ์์ฅ (ํ๋ฌธ ๋น๋ฐ๋ฒํธ)
   */
  async function handleLogin() {
      let userId = document.getElementById("userId").value;
      let password = document.getElementById("password").value;
      let autoLogin = document.getElementById("autoLoginToggle").checked; // ์๋ ๋ก๊ทธ์ธ ์ฒดํฌ ์ฌ๋ถ

      if (userId === "" || password === "") {
          alert("์์ด๋์ ๋น๋ฐ๋ฒํธ๋ฅผ ์๋ฅํ์ธ์.");
          return false;
      }

      console.log("๐น ๋ก๊ทธ์ธ ์๋ - ID:", userId);

      // ๐น ์๋ ๋ก๊ทธ์ธ ์ฒดํฌ ์ ํ๋ฌธ ๋น๋ฐ๋ฒํธ๋ฅผ ์ฟํค์ ์์ฅ
      if (autoLogin) {
          setCookie("autoLoginId", userId, 7);  // 7์ผ ๋์ ์์ง
          setCookie("autoLoginPw", password, 7);
      } else {
          deleteCookie("autoLoginId");
          deleteCookie("autoLoginPw");
      }

      return true; // ํผ ์์ถ ์งํ
  }

  /**
   * ๐น ์ฟํค ์ค์ ํจ์ (SameSite ๋ฐ Secure ์์ฑ ์ถ๊ฐ)
   */
  function setCookie(name, value, days) {
      let date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/;SameSite=Strict;Secure`;
  }

  /**
   * ๐น ์ฟํค ๊ฐ์ธ์ค๊ธฐ ํจ์
   */
  function getCookie(name) {
      let cookies = document.cookie.split("; ");
      for (let cookie of cookies) {
          let [key, value] = cookie.split("=");
          if (key === name) return value;
      }
      return null;
  }

  /**
   * ๐น ์ฟํค ์ญ์ ํจ์
   */
  function deleteCookie(name) {
      document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict;Secure`;
  }

  /**
   * ๐น ์๋ ๋ก๊ทธ์ธ ํ์ธ ๋ฐ ์์ฉ
   */
  window.onload = async function () {
      let savedId = getCookie("autoLoginId");
      let savedPw = getCookie("autoLoginPw"); // โ ํ๋ฌธ ๋น๋ฐ๋ฒํธ ๊ฐ์ธ์ค๊ธฐ (์ํธํ ์ ํจ)

      console.log("๐ ์๋ ๋ก๊ทธ์ธ ์ฒดํฌ - ID:", savedId);

      if (savedId && savedPw) {
          console.log("๐ ์๋ ๋ก๊ทธ์ธ ์๋...");

          let response = await fetch("/api/auto-login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: savedId, pw: savedPw }) // โ ํ๋ฌธ ๋น๋ฐ๋ฒํธ ๊ทธ๋๋ก ์์ก
          });

          let result = await response.text();
          if (result === "SUCCESS") {
              console.log("โ ์๋ ๋ก๊ทธ์ธ ์ฑ๊ณต");
              alert("์๋ ๋ก๊ทธ์ธ ์๋ฃ!");
              window.location.href = "/maindashboard";
          } else {
              console.log("โ ์๋ ๋ก๊ทธ์ธ ์คํจ");
              alert("์๋ ๋ก๊ทธ์ธ ์คํจ! ๋ค์ ๋ก๊ทธ์ธํ์ธ์.");
              deleteCookie("autoLoginId");
              deleteCookie("autoLoginPw");
          }
      }
  };

  /**
   * ๐น ๋ก๊ทธ์์ ์ ์ฟํค ์ญ์
   */
  function logout() {
      deleteCookie("autoLoginId");
      deleteCookie("autoLoginPw");

      fetch("/api/auth/logout", { method: "POST" })
          .then(() => {
              alert("๋ก๊ทธ์์ ์๋ฃ!");
              window.location.href = "/login";
          });
  }

  </script>
</body>
</html>
