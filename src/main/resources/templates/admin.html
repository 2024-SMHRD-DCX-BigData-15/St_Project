<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ìŠ¹ì¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <header class="header">
                <div class="header-content">
                    <h1 class="page-title">íšŒì› ìŠ¹ì¸ ê´€ë¦¬</h1>
                    <div class="user-info">
                        <div th:if="${session.loginUser != null}">
                            <p th:text="${session.loginUser.userId}" class="user-name"></p> <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë¦„ ì¶œë ¥ -->
                        </div>
                        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </header>

            <!-- íšŒì› ëª©ë¡ í…Œì´ë¸” -->
            <section class="approval-container">
                <table class="approval-table">
                    <thead>
                        <tr>
                            <th>íšŒì› ì•„ì´ë””</th>
                            <th>íšŒì› ì´ë¦„</th>
                            <th>ì–‘ì‹ì¥ ì£¼ì†Œ</th>
                            <th>íšŒì› ì—°ë½ì²˜</th>
                            <th>ê°€ì… ë‚ ì§œ</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="approval-table-body">
                        <!-- ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
    function handleLogout() {
        console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");

        const authToken = localStorage.getItem("authToken");

        fetch("/api/member/logout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: authToken }),
        })
        .then(response => {
            if (response.ok) {
                console.log("âœ… ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");

                localStorage.removeItem("authToken");
                localStorage.removeItem("autoLogin");
                localStorage.removeItem("savedUserId");
                localStorage.removeItem("savedPassword");
                sessionStorage.clear();

                document.cookie = "JSESSIONID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

                console.log("âœ… ëª¨ë“  ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ");

                setTimeout(() => {
                    alert("âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
                    window.location.href = "/login";
                }, 1000);
            } else {
                console.warn("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ì‘ë‹µ ì˜¤ë¥˜");
            }
        })
        .catch(error => console.error("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
    }


        // ì„œë²„ì—ì„œ ì‚¬ìš©ì ë°ì´í„° ë°›ì•„ì˜¤ê¸°
        document.addEventListener("DOMContentLoaded", function () {
        	const scrollY = window.scrollY;
    fetch('/api/member')
        .then(response => response.json())
        .then(users => {
            const tbody = document.getElementById('approval-table-body');

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.userName}</td>
                    <td>${user.userAdd}</td>
                    <td>${user.userPhone}</td>
                    <td>${user.joinedAt}</td>
                    <td>
                        <span class="status ${user.userStatus === 'Y' ? 'status-pending' : 'status-approved'}">
                            ${user.userStatus === 'Y' ? 'ëŒ€ê¸° ì¤‘' : 'ìŠ¹ì¸ë¨'}
                        </span>
                    </td>
                    <td>
                        <button class="approve-btn" ${user.userStatus === 'N' ? 'disabled' : ''}>ìŠ¹ì¸</button>
                        <button class="reject-btn" ${user.userStatus === 'Y' ? 'disabled' : ''}>ê±°ë¶€</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let row = this.closest('tr');
                    let userId = row.querySelector('td:first-child').textContent.trim();

                    fetch(`/api/member/approve/${userId}`, { method: "PUT" })
                        .then(response => {
                            if (!response.ok) throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                            return response.text();
                        })
                        .then(data => {
                            console.log("âœ… íšŒì› ìŠ¹ì¸ ì„±ê³µ:", data);
                            row.querySelector('.status').textContent = 'ìŠ¹ì¸ë¨';
                            row.querySelector('.status').classList.remove('status-pending');
                            row.querySelector('.status').classList.add('status-approved');
                            row.querySelector('.approve-btn').disabled = true;
                            row.querySelector('.reject-btn').disabled = false;
                        })
                        .catch(error => console.error("âŒ íšŒì› ìŠ¹ì¸ ì‹¤íŒ¨:", error));
                });
            });

            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let row = this.closest('tr');
                    let userId = row.querySelector('td:first-child').textContent.trim();

                    fetch(`/api/member/reject/${userId}`, { method: "PUT" })
                        .then(response => {
                            if (!response.ok) throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                            return response.text();
                        })
                        .then(data => {
                            console.log("âŒ íšŒì› ê±°ë¶€ ì„±ê³µ:", data);
                            row.querySelector('.status').textContent = 'ëŒ€ê¸° ì¤‘';
                            row.querySelector('.status').classList.remove('status-approved');
                            row.querySelector('.status').classList.add('status-pending');
                            row.querySelector('.approve-btn').disabled = false;
                            row.querySelector('.reject-btn').disabled = true;
                        })
                        .catch(error => console.error("âŒ íšŒì› ê±°ë¶€ ì‹¤íŒ¨:", error));
                });
            });
        })
        .catch(error => console.error("âŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error));
});
    </script>
</body>
</html>
