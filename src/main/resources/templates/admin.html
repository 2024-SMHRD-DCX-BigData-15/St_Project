<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 승인 페이지</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="wrapper">
        <!-- 사이드바 -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>메뉴</h2>
        </div>
        <ul class="sidebar-menu">
          <!-- 수조 관리 시스템 -->
          <li>
            <a href="javascript:void(0)" class="toggle-menu">수조 관리</a>
            <ul class="sub-menu">
              <li><a href="#">수조 정보 등록</a></li>
              <li><a href="#">수조 정보 수정</a></li>
            </ul>
          </li>
      
          <!-- 회원 정보 관리 -->
          <li>
            <a href="javascript:void(0)" class="toggle-menu">회원 정보 관리</a>
            <ul class="sub-menu">
              <li><a href="#">회원 정보 수정</a></li>
              <li><a href="#">회원 탈퇴</a></li>
            </ul>
          </li>
        </ul>
      </div>

        <!-- 햄버거 메뉴 -->
        <div class="hamburger-menu" id="hamburger-menu">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <header class="header">
                <h1 class="page-title">회원 승인 관리</h1>
            </header>

            <!-- 회원 목록 테이블 -->
            <section class="approval-container">
                <table class="approval-table">
                    <thead>
                        <tr>
                            <th>회원 아이디</th>
                            <th>회원 이름</th>
                            <th>양식장 주소</th>
                            <th>회원 연락처</th>
                            <th>가입 날짜</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="approval-table-body">
                        <!-- 서버에서 데이터를 받아와서 동적으로 여기에 삽입됩니다 -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        document.getElementById('hamburger-menu').addEventListener('click', function() {
        // 사이드바 열기/닫기 토글
        document.getElementById('sidebar').classList.toggle('open');
        
        // 햄버거 메뉴 애니메이션
        this.classList.toggle('open');
      });

                      // "수조 관리"와 "회원 정보 관리"를 클릭할 때 sub-menu 열기
          document.querySelectorAll('.toggle-menu').forEach(menu => {
            menu.addEventListener('click', function() {
              const subMenu = this.nextElementSibling; // 클릭된 항목 바로 다음의 ul.sub-menu

              // 이미 열려 있는 경우 숨기기
              if (subMenu.classList.contains('open')) {
                subMenu.classList.remove('open');
              } else {
                // 다른 메뉴들은 닫히게 함
                document.querySelectorAll('.sub-menu').forEach(menu => {
                  menu.classList.remove('open');
                });

                // 클릭된 메뉴만 열기
                subMenu.classList.add('open');
              }
            });
          });


        // 서버에서 사용자 데이터 받아오기
        document.addEventListener("DOMContentLoaded", function () {
    fetch('/api/member')
        .then(response => response.json())
        .then(users => {
            const tbody = document.getElementById('approval-table-body');

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.userId}</td>
                    <td>${user.userName}</td>
                    <td>${user.userAdd}</td>
                    <td>${user.userPhone}</td>
                    <td>${user.joinedAt}</td>
                    <td>
                        <span class="status ${user.userStatus === 'Y' ? 'status-pending' : 'status-approved'}">
                            ${user.userStatus === 'Y' ? '대기 중' : '승인됨'}
                        </span>
                    </td>
                    <td>
                        <button class="approve-btn" ${user.userStatus === 'N' ? 'disabled' : ''}>승인</button>
                        <button class="reject-btn" ${user.userStatus === 'Y' ? 'disabled' : ''}>거부</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let row = this.closest('tr');
                    let userId = row.querySelector('td:first-child').textContent.trim();

                    fetch(`/api/member/approve/${userId}`, { method: "PUT" })
                        .then(response => {
                            if (!response.ok) throw new Error(`❌ 서버 응답 오류: ${response.status}`);
                            return response.text();
                        })
                        .then(data => {
                            console.log("✅ 회원 승인 성공:", data);
                            row.querySelector('.status').textContent = '승인됨';
                            row.querySelector('.status').classList.remove('status-pending');
                            row.querySelector('.status').classList.add('status-approved');
                            row.querySelector('.approve-btn').disabled = true;
                            row.querySelector('.reject-btn').disabled = false;
                        })
                        .catch(error => console.error("❌ 회원 승인 실패:", error));
                });
            });

            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    let row = this.closest('tr');
                    let userId = row.querySelector('td:first-child').textContent.trim();

                    fetch(`/api/member/reject/${userId}`, { method: "PUT" })
                        .then(response => {
                            if (!response.ok) throw new Error(`❌ 서버 응답 오류: ${response.status}`);
                            return response.text();
                        })
                        .then(data => {
                            console.log("❌ 회원 거부 성공:", data);
                            row.querySelector('.status').textContent = '대기 중';
                            row.querySelector('.status').classList.remove('status-approved');
                            row.querySelector('.status').classList.add('status-pending');
                            row.querySelector('.approve-btn').disabled = false;
                            row.querySelector('.reject-btn').disabled = true;
                        })
                        .catch(error => console.error("❌ 회원 거부 실패:", error));
                });
            });
        })
        .catch(error => console.error("❌ 데이터 가져오기 실패:", error));
});
    </script>
</body>
</html>
