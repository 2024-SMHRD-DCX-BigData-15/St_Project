<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ìƒˆìš°ì–‘ì‹ ê´€ì œì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ" />
    <link rel="stylesheet" href="/css/dashboarddetail.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ê´€ì œì„¼í„° ëŒ€ì‹œë³´ë“œ</title>
  </head>
  <body>
    <!-- í–„ë²„ê±° ë²„íŠ¼ -->
    <button class="hamburger-btn" id="hamburgerBtn">â˜°</button>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ë©”ë‰´</h2>
      </div>
      <ul class="sidebar-menu">
        <li><a href="/maindashboard" class="toggle-menu">í™ˆ</a></li>
        <li><a href="/tank" class="toggle-menu">ìˆ˜ì¡° ì •ë³´ ë“±ë¡</a></li>
        <li><a href="/alarmHistory2" class="toggle-menu">ì•ŒëŒ íˆìŠ¤í† ë¦¬</a></li>
        <li>
          <a href="javascript:void(0)" class="toggle-menu">íšŒì› ì •ë³´ ê´€ë¦¬</a>
          <ul class="sub-menu">
            <li><a th:href="@{/edit/{id}(id=${session.loginUser.userId})}">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="/delete">íšŒì› íƒˆí‡´</a></li>
          </ul>
        </li>
      </ul>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <header class="header">
        <h1 class="page-title">ì„¸ë¶€ê´€ì œì‹œìŠ¤í…œ</h1>
        <div class="user-info">
          <div th:if="${session.loginUser != null}">
            <p th:text="${session.loginUser.userId}"></p>
          </div>
          <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </header>

      <!-- ë°ì´í„° ì¹´ë“œ -->
      <section class="dashboard-cards">
        <div class="card card-ph" id="ph-item-1">
          <h4>ì‚°ì„±ë„</h4>
          <div class="data-container">
            <canvas id="chart-1" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="ph-1">-</span>
          </div>
        </div>
        <div class="card card-oxygen" id="do-item-1">
          <h4>ìš©ì¡´ì‚°ì†Œ</h4>
          <div class="data-container">
            <canvas id="chart-2" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="do-1">-</span>
          </div>
        </div>
        <div class="card card-temperature" id="temp-item-1">
          <h4>ìˆ˜ì˜¨</h4>
          <div class="data-container">
            <canvas id="chart-3" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="temp-1">-</span>
          </div>
        </div>
        <div class="card card-salinity" id="salt-item-1">
          <h4>ì—¼ë„</h4>
          <div class="data-container">
            <canvas id="chart-4" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="salt-1">-</span>
          </div>
        </div>
        <div class="card card-ammonia" id="ammonia-item-1">
          <h4>ì•”ëª¨ë‹ˆì•„</h4>
          <div class="data-container">
            <canvas id="chart-5" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="ammonia-1">-</span>
          </div>
        </div>
        <div class="card card-nitrite" id="nitrogen-item-1">
          <h4>ì•„ì§ˆì‚°</h4>
          <div class="data-container">
            <canvas id="chart-6" width="200" height="200"></canvas>
          </div>
          <div class="data-value-container">
            <span class="data-value" id="nitrogen-1">-</span>
          </div>
        </div>
      </section>

      <!-- ìˆ˜ì¡°ì •ë³´ì™€ ì‹¤ì‹œê°„ ê·¸ë˜í”„ -->
      <section class="dashboard-cards">
        <div class="tank-info">
          <h4>ìˆ˜ì¡°ì •ë³´</h4><br>
          <p><strong>ìˆ˜ì¡° ID:</strong> <span th:text="${selectedTank?.tankIdx ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>ì§ê²½:</strong> <span th:text="${selectedTank?.tankWidth ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
          <p><strong>ë†’ì´:</strong> <span th:text="${selectedTank?.tankHeight ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
          <p><strong>ìœ„ì¹˜:</strong> <span th:text="${selectedTank?.tankLocation ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>í’ˆì¢…:</strong> <span th:text="${selectedTank?.fishType ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>ì‚¬ìœ¡ ê°œì‹œì¼:</strong><span th:text="${selectedTank?.startedAt != null ? #temporals.format(selectedTank.startedAt, 'yyyy-MM-dd') : 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <canvas id="tank-data"></canvas>
        </div>
        <div class="card card-graph">
          <div class="graph-container">
            <canvas id="aihubGraph"></canvas>
          </div>
        </div>
      </section>
    </main>

    <script>
      // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
      function handleLogout() {
        console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");
        const authToken = localStorage.getItem("authToken");
        fetch("/api/member/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: authToken }),
        })
        .then(response => {
          if (response.ok) {
            console.log("âœ… ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
            localStorage.removeItem("authToken");
            localStorage.removeItem("autoLogin");
            localStorage.removeItem("savedUserId");
            localStorage.removeItem("savedPassword");
            sessionStorage.clear();
            document.cookie = "JSESSIONID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            console.log("âœ… ëª¨ë“  ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
            setTimeout(() => {
              alert("âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
              window.location.href = "/login";
            }, 1000*60*60*24);
          } else {
            console.warn("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ì‘ë‹µ ì˜¤ë¥˜");
          }
        })
        .catch(error => console.error("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }

      // DOMContentLoaded ì´ë²¤íŠ¸
      document.addEventListener("DOMContentLoaded", function () {
        // ì‚¬ì´ë“œë°” í† ê¸€
        document.getElementById("hamburgerBtn").addEventListener("click", () => {
          document.getElementById("sidebar").classList.toggle("active");
        });

        // ì„œë¸Œ ë©”ë‰´ í† ê¸€
        const toggleMenus = document.querySelectorAll(".toggle-menu");
        toggleMenus.forEach(menu => {
          menu.addEventListener("click", (e) => {
            const subMenu = menu.nextElementSibling;
            if (subMenu && subMenu.classList.contains("sub-menu")) {
              e.preventDefault();
              subMenu.style.display = subMenu.style.display === "block" ? "none" : "block";
            }
          });
        });

        // ì „ì—­ ë³€ìˆ˜ ì •ì˜
        const dataRanges = {
          'chart-1': { min: 7.3, max: 9.2, label: 'pH' },
          'chart-2': { min: 5.0, max: 15.0, label: 'Oâ‚‚ (mg/L)' },
          'chart-3': { min: 24.77, max: 31.0, label: 'Â°C' },
          'chart-4': { min: 0.5, max: 47.0, label: 'ppt' },
          'chart-5': { min: 0.0, max: 0.5, label: 'NHâ‚ƒ (mg/L)' },
          'chart-6': { min: 0.0, max: 5.2, label: 'NOâ‚‚ (mg/L)' },
        };

        let gaugeValues = {
          'chart-1': null,
          'chart-2': null,
          'chart-3': null,
          'chart-4': null,
          'chart-5': null,
          'chart-6': null,
        };

        let realtimeChart = null;
        // ê²Œì´ì§€ ê´€ë ¨ ë³€ìˆ˜ ì •ì˜
        const canvasElements = [
          document.getElementById('chart-1'),
          document.getElementById('chart-2'),
          document.getElementById('chart-3'),
          document.getElementById('chart-4'),
          document.getElementById('chart-5'),
          document.getElementById('chart-6'),
        ];

        const angles = {
          'chart-1': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
          'chart-2': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
          'chart-3': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
          'chart-4': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
          'chart-5': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
          'chart-6': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        };

        const animationStates = {
          'chart-1': { animating: false },
          'chart-2': { animating: false },
          'chart-3': { animating: false },
          'chart-4': { animating: false },
          'chart-5': { animating: false },
          'chart-6': { animating: false },
        };

        const ranges = [
          // ì‚°ì„±ë„ (pH)
          {
            warning1Min: 7.3,   warning1Max: 7.49,   // ê²½ê³ : 7.3 ~ 7.49 (ë‚®ìŒ)
            normalMin: 7.5,     normalMax: 9.0,     // ì •ìƒ: 7.5 ~ 9.0
            warning2Min: 9.1,   warning2Max: 9.2,   // ê²½ê³ : 9.1 ~ 9.2 (ë†’ìŒ)
            min: 7.3, max: 9.2   // ì •ê·œí™” ë²”ìœ„
          },
          // ìš©ì¡´ì‚°ì†Œ (mg/L)
          {
            warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ
            normalMin: 5.0,     normalMax: 10.0,    // ì •ìƒ: 5.0 ~ 10.0
            warning2Min: 10.1,  warning2Max: 15.0,  // ê²½ê³ : 10.1 ~ 15.0 (ë†’ìŒ)
            min: 3.0, max: 15.0  // ì •ê·œí™” ë²”ìœ„
          },
          // ìˆ˜ì˜¨ (Â°C)
          {
            warning1Min: 24.77, warning1Max: 25.9,  // ê²½ê³ : 24.77 ~ 25.9 (ë‚®ìŒ)
            normalMin: 26.0,    normalMax: 30.0,    // ì •ìƒ: 26.0 ~ 30.0
            warning2Min: 30.1,  warning2Max: 31.0,  // ê²½ê³ : 30.1 ~ 31.0 (ë†’ìŒ)
            min: 24.77, max: 31.0 // ì •ê·œí™” ë²”ìœ„
          },
          // ì—¼ë„ (ppt)
          {
            warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ
            normalMin: 0.5,     normalMax: 45.0,    // ì •ìƒ: 0.5 ~ 45.0
            warning2Min: 45.1,  warning2Max: 47.0,  // ê²½ê³ : 45.1 ~ 47.0 (ë†’ìŒ)
            min: 0.5, max: 47.0  // ì •ê·œí™” ë²”ìœ„
          },
          // ì•”ëª¨ë‹ˆì•„ (ppm)
          {
            warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ
            normalMin: 0.0,     normalMax: 0.16,    // ì •ìƒ: 0.0 ~ 0.16
            warning2Min: 0.3,   warning2Max: 0.5,   // ê²½ê³ : 0.3 ~ 0.5 (ë†’ìŒ)
            min: 0.0, max: 0.5   // ì •ê·œí™” ë²”ìœ„
          },
          // ì•„ì§ˆì‚° (ppm)
          {
            warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ
            normalMin: 0.0,     normalMax: 5.0,     // ì •ìƒ: 0.0 ~ 5.0
            warning2Min: 5.1,   warning2Max: 5.2,   // ê²½ê³ : 5.1 ~ 5.2 (ë†’ìŒ)
            min: 0.0, max: 5.2   // ì •ê·œí™” ë²”ìœ„
          }
        ];

        const chartIndexMap = {
          'chart-1': 0, 'chart-2': 1, 'chart-3': 2, 'chart-4': 3, 'chart-5': 4, 'chart-6': 5
        };

        const tankIdxMap = {
          'chart-1': '1',
          'chart-2': '1',
          'chart-3': '1',
          'chart-4': '1',
          'chart-5': '1',
          'chart-6': '1',
        };

        function getDataItem(chartId, tankIdx) {
          const dataItems = {
            'chart-1': document.getElementById(`ph-item-${tankIdx}`),
            'chart-2': document.getElementById(`do-item-${tankIdx}`),
            'chart-3': document.getElementById(`temp-item-${tankIdx}`),
            'chart-4': document.getElementById(`salt-item-${tankIdx}`),
            'chart-5': document.getElementById(`ammonia-item-${tankIdx}`),
            'chart-6': document.getElementById(`nitrogen-item-${tankIdx}`),
          };
          return dataItems[chartId];
        }

        function getColor(value, range) {
          console.log(`getColor - value: ${value}, range:`, range);
          if (value === null || isNaN(value)) {
            value = (range.normalMin + range.normalMax) / 2;
            console.log(`Value is null or NaN, setting to default: ${value}`);
          }
          if (range.warning1Min !== null && range.warning1Max !== null && value >= range.warning1Min && value <= range.warning1Max) {
            console.log(`Warning 1: ${value} is between ${range.warning1Min} and ${range.warning1Max}`);
            return { background: '#ff4500', border: '#ff7f7f', status: 'warning' };
          }
          if (value >= range.normalMin && value <= range.normalMax) {
            console.log(`Normal: ${value} is between ${range.normalMin} and ${range.normalMax}`);
            return { background: '#32cd32', border: '#90ee90', status: 'normal' };
          }
          if (range.warning2Min !== null && range.warning2Max !== null && value >= range.warning2Min && value <= range.warning2Max) {
            console.log(`Warning 2: ${value} is between ${range.warning2Min} and ${range.warning2Max}`);
            return { background: '#ff4500', border: '#ff7f7f', status: 'warning' };
          }
          if ((value > range.normalMax && (range.warning2Min === null || value < range.warning2Min)) || 
              (range.warning2Max !== null && value > range.warning2Max)) {
            console.log(`Warning (out of normal range): ${value} is outside normal range (${range.normalMin} - ${range.normalMax})`);
            return { background: '#ff4500', border: '#ff7f7f', status: 'warning' };
          }
          if (value < range.normalMin && (range.warning1Min === null || value < range.warning1Min)) {
            console.log(`Warning (below normal range): ${value} is below normal range (${range.normalMin} - ${range.normalMax})`);
            return { background: '#ff4500', border: '#ff7f7f', status: 'warning' };
          }
          console.log(`Default warning: ${value} does not fit any range`);
          return { background: '#ff4500', border: '#ff7f7f', status: 'warning' };
        }

        function easeOutQuad(t) {
          return 1 - (1 - t) * (1 - t);
        }

        function updateGauge(chartId, value, min, max) {
          const rangeIndex = chartIndexMap[chartId];
          const range = ranges[rangeIndex];

          if (value === null || value === undefined || isNaN(value)) {
            value = (range.normalMin + range.normalMax) / 2;
            console.warn(`updateGauge: ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ - chartId: ${chartId}, ê¸°ë³¸ê°’ ${value}ìœ¼ë¡œ ì„¤ì •`);
          }

          // ê°’ì„ ë²”ìœ„ ë‚´ë¡œ í´ë¨í•‘
          value = Math.max(range.min, Math.min(range.max, value));
          gaugeValues[chartId] = value;

          const totalAngle = Math.PI; // 180ë„
          const startAngle = Math.PI; // ì‹œì‘ ê°ë„ (180ë„)
          const sectionAngle = totalAngle / 3; // ê° êµ¬ê°„ì˜ ê°ë„ (60ë„)

          let targetAngle;

          // ë°ì´í„° ë²”ìœ„ì™€ êµ¬ê°„ ë§¤í•‘
          if (value < range.normalMin) {
            // ë‚®ì€ ê²½ê³  êµ¬ê°„ (warning1)
            if (range.warning1Min !== null && range.warning1Max !== null) {
              const warning1Range = range.normalMin - range.warning1Min;
              const warning1Ratio = (value - range.warning1Min) / warning1Range;
              targetAngle = startAngle + warning1Ratio * sectionAngle;
            } else {
              // ë‚®ì€ ê²½ê³  êµ¬ê°„ì´ ì—†ìœ¼ë©´ ì‹œì‘ì ìœ¼ë¡œ ê³ ì •
              targetAngle = startAngle;
            }
          } else if (value > range.normalMax) {
            // ë†’ì€ ê²½ê³  êµ¬ê°„ (warning2)
            if (range.warning2Min !== null && range.warning2Max !== null) {
              const warning2Range = range.warning2Max - range.normalMax;
              const warning2Ratio = (value - range.normalMax) / warning2Range;
              targetAngle = startAngle + 2 * sectionAngle + warning2Ratio * sectionAngle;
            } else {
              // ë†’ì€ ê²½ê³  êµ¬ê°„ì´ ì—†ìœ¼ë©´ ëì ìœ¼ë¡œ ê³ ì •
              targetAngle = startAngle + 2 * sectionAngle;
            }
          } else {
            // ì •ìƒ êµ¬ê°„ (normal)
            const normalRange = range.normalMax - range.normalMin;
            const normalRatio = (value - range.normalMin) / normalRange;
            targetAngle = startAngle + sectionAngle + normalRatio * sectionAngle;
          }

          // ê°ë„ ì œí•œ (Math.PI ~ 2*Math.PI)
          targetAngle = Math.max(Math.PI, Math.min(2 * Math.PI, targetAngle));
          angles[chartId].target = targetAngle;

          // ê²½ê³  ìƒíƒœ í™•ì¸ ë° ê¹œë¹¡ì„ ì ìš©
          const tankIdx = tankIdxMap[chartId];
          const dataItem = getDataItem(chartId, tankIdx);
          const colors = getColor(value, range);
          if (dataItem) {
            if (colors.status === 'warning') {
              dataItem.classList.add('blink-data-item');
            } else {
              dataItem.classList.remove('blink-data-item');
            }
          } else {
            console.error(`Data item not found for chartId: ${chartId}, tankIdx: ${tankIdx}`);
          }

          if (!animationStates[chartId].animating) {
            animationStates[chartId].animating = true;
            animateGauge(chartId);
          }
        }

        function animateGauge(chartId) {
        	  const canvas = document.getElementById(chartId);
        	  const ctx = canvas.getContext("2d");
        	  const canvasWidth = canvas.width;
        	  const canvasHeight = canvas.height;

        	  const startAngle = angles[chartId].current;
        	  const targetAngle = angles[chartId].target;
        	  const duration = 600; // 600msë¡œ ì„¤ì •
        	  let startTime = null;

        	  function step(timestamp) {
        	    if (!startTime) startTime = timestamp;
        	    const elapsed = timestamp - startTime;
        	    const progress = Math.min(elapsed / duration, 1);
        	    const easedProgress = easeOutBack(progress); // easeOutBackìœ¼ë¡œ ë³€ê²½

        	    angles[chartId].current = startAngle + (targetAngle - startAngle) * easedProgress;

        	    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        	    drawGaugeOnCanvas(chartId, canvas);

        	    const centerX = canvasWidth / 2;
        	    const centerY = canvasHeight - 50;
        	    const len = 80;

        	    ctx.beginPath();
        	    ctx.moveTo(centerX, centerY);
        	    ctx.lineTo(centerX + Math.cos(angles[chartId].current) * len, centerY + Math.sin(angles[chartId].current) * len);
        	    ctx.strokeStyle = 'red';
        	    ctx.lineWidth = 4;
        	    ctx.stroke();

        	    if (progress < 1) {
        	      requestAnimationFrame(step);
        	    } else {
        	      animationStates[chartId].animating = false;
        	    }
        	  }

        	  requestAnimationFrame(step);
        	}

	        function easeOutBack(t) {
	        	  const c1 = 1.2; // ì˜¤ë²„ìŠˆíŠ¸ ê°•ë„ ì¡°ì • (ê¸°ë³¸ê°’ 1.70158ì—ì„œ ë” ë¶€ë“œëŸ½ê²Œ 1.2ë¡œ ë‚®ì¶¤)
	        	  const c3 = c1 + 1;
	        	  return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
	        	}

        function drawGaugeOnCanvas(canvasId, canvas) {
          const ctx = canvas.getContext('2d');
          const canvasWidth = canvas.width;
          const canvasHeight = canvas.height;
          const centerX = canvasWidth / 2;
          const centerY = canvasHeight - 50;
          const radius = 100;
          const gaugeWidth = 30;

          const colors = {
            warning1: ['#ff4500', '#ff7f7f'],
            normal: ['#32cd32', '#90ee90'],
            warning2: ['#ff4500', '#ff7f7f']
          };

          const labels = { warning1: 'ê²½ê³ ', normal: 'ì •ìƒ', warning2: 'ê²½ê³ ' };
          const rangeIndex = chartIndexMap[canvasId];
          const range = ranges[rangeIndex];

          function drawGauge() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            const totalAngle = Math.PI;
            const startAngle = Math.PI;
            const sectionAngle = totalAngle / 3;
            let currentAngle = startAngle;

            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
            ctx.shadowBlur = 10;
            ctx.lineWidth = 2;
            // ì²« ë²ˆì§¸ êµ¬ê°„: í•­ìƒ ë¹¨ê°„ìƒ‰ (ë‚®ìŒ ê²½ê³ )
            drawSection(currentAngle, sectionAngle, colors.warning1);
            currentAngle += sectionAngle;

            // ë‘ ë²ˆì§¸ êµ¬ê°„: í•­ìƒ ì´ˆë¡ìƒ‰ (ì •ìƒ)
            drawSection(currentAngle, sectionAngle, colors.normal);
            currentAngle += sectionAngle;

            // ì„¸ ë²ˆì§¸ êµ¬ê°„: í•­ìƒ ë¹¨ê°„ìƒ‰ (ë†’ìŒ ê²½ê³ )
            drawSection(currentAngle, sectionAngle, colors.warning2);

            ctx.shadowBlur = 0;
            drawLabels(startAngle, sectionAngle);
          }

          function drawSection(start, angle, colorPair) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, start, start + angle);
            ctx.arc(centerX, centerY, radius - gaugeWidth, start + angle, start, true);
            ctx.closePath();
            ctx.fillStyle = colorPair[0];
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.stroke();
          }

          function drawLabels(startAngle, sectionAngle) {
            const labelRadius = radius - gaugeWidth / 2;
            ctx.fillStyle = '#000';
            ctx.font = 'bold 15px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const angles = [
              startAngle + sectionAngle / 2,
              startAngle + sectionAngle + sectionAngle / 2,
              startAngle + sectionAngle * 2 + sectionAngle / 2
            ];
            const texts = [labels.warning1, labels.normal, labels.warning2];

            angles.forEach((angle, i) => {
              const x = centerX + Math.cos(angle) * labelRadius;
              const y = centerY + Math.sin(angle) * labelRadius;
              ctx.fillText(texts[i], x, y);
            });
          }

          drawGauge();
        }

        // ì´ˆê¸° ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
        canvasElements.forEach(canvas => {
          drawGaugeOnCanvas(canvas.id, canvas);
        });

        // ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì—…ë°ì´íŠ¸
        async function fetchLatestTankData(tankIdx) {
          try {
            const response = await fetch(`/tank/data/latest?tankIdx=${tankIdx}`);
            if (!response.ok) throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
            const data = await response.json();
            console.log("âœ… ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", data);
            return data;
          } catch (error) {
            console.error("âŒ ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const defaultData = {
              waterPh: (ranges[0].normalMin + ranges[0].normalMax) / 2,
              waterDo: (ranges[1].normalMin + ranges[1].normalMax) / 2,
              waterTemp: (ranges[2].normalMin + ranges[2].normalMax) / 2,
              waterSalt: (ranges[3].normalMin + ranges[3].normalMax) / 2,
              waterAmmonia: (ranges[4].normalMin + ranges[4].normalMax) / 2,
              waterNitrogen: (ranges[5].normalMin + ranges[5].normalMax) / 2
            };
            console.warn("âš ï¸ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •:", defaultData);
            return defaultData;
          }
        }

        async function updateTankData(tankIdx) {
          const latestData = await fetchLatestTankData(tankIdx);
          if (latestData) {
            // ë°ì´í„° í‘œì‹œ
            document.getElementById(`ph-${tankIdx}`).textContent = latestData.waterPh ? latestData.waterPh.toFixed(3) : '-';
            document.getElementById(`do-${tankIdx}`).textContent = latestData.waterDo ? latestData.waterDo.toFixed(3) : '-';
            document.getElementById(`temp-${tankIdx}`).textContent = latestData.waterTemp ? latestData.waterTemp.toFixed(3) : '-';
            document.getElementById(`salt-${tankIdx}`).textContent = latestData.waterSalt ? latestData.waterSalt.toFixed(3) : '-';
            document.getElementById(`ammonia-${tankIdx}`).textContent = latestData.waterAmmonia ? latestData.waterAmmonia.toFixed(3) : '-';
            document.getElementById(`nitrogen-${tankIdx}`).textContent = latestData.waterNitrogen ? latestData.waterNitrogen.toFixed(3) : '-';

            // ìˆ˜ì§ˆ ë°ì´í„° ë°°ì—´
            const dataValues = [
              parseFloat(latestData.waterPh),        // ì‚°ì„±ë„
              parseFloat(latestData.waterDo),        // ìš©ì¡´ì‚°ì†Œ
              parseFloat(latestData.waterTemp),      // ìˆ˜ì˜¨
              parseFloat(latestData.waterSalt),      // ì—¼ë„
              parseFloat(latestData.waterAmmonia),   // ì•”ëª¨ë‹ˆì•„
              parseFloat(latestData.waterNitrogen)   // ì•„ì§ˆì‚°
            ];

            // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë° ê¹œë¹¡ì„ ë™ê¸°í™”
            const textElements = [
              document.getElementById(`ph-${tankIdx}`),
              document.getElementById(`do-${tankIdx}`),
              document.getElementById(`temp-${tankIdx}`),
              document.getElementById(`salt-${tankIdx}`),
              document.getElementById(`ammonia-${tankIdx}`),
              document.getElementById(`nitrogen-${tankIdx}`)
            ];

            const dataItems = [
              document.getElementById(`ph-item-${tankIdx}`),
              document.getElementById(`do-item-${tankIdx}`),
              document.getElementById(`temp-item-${tankIdx}`),
              document.getElementById(`salt-item-${tankIdx}`),
              document.getElementById(`ammonia-item-${tankIdx}`),
              document.getElementById(`nitrogen-item-${tankIdx}`)
            ];

            dataValues.forEach((value, index) => {
              const colors = getColor(value, ranges[index]);
              textElements[index].style.color = colors.border;
              if (colors.status === 'warning') {
                dataItems[index].classList.add('blink-data-item');
              } else {
                dataItems[index].classList.remove('blink-data-item');
              }

              // ê²Œì´ì§€ ì—…ë°ì´íŠ¸
              const chartId = `chart-${index + 1}`;
              updateGauge(chartId, value, dataRanges[chartId].min, dataRanges[chartId].max);
            });
          }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ì£¼ê¸°ì  ê°±ì‹ 
        const urlParams = new URLSearchParams(window.location.search);
        const tankIdx = urlParams.get("tankIdx") || '1'; // ê¸°ë³¸ê°’ìœ¼ë¡œ '1' ì„¤ì •
        updateTankData(tankIdx);
        setInterval(() => updateTankData(tankIdx), 700);

        // í´ë¦­ ì´ë²¤íŠ¸ ë° ì‹¤ì‹œê°„ ë°ì´í„°
        const cardElements = document.querySelectorAll('.card');
        let labelsMap = {};
        let valuesMap = {};

        cardElements.forEach(card => {
          const canvas = card.querySelector('canvas');
          const chartId = canvas.id;
          labelsMap[chartId] = [];
          valuesMap[chartId] = [];

          card.addEventListener('click', () => {
            cardElements.forEach(c => c.classList.remove('clicked', 'animate-click'));
            card.classList.add('clicked', 'animate-click');
            setTimeout(() => card.classList.remove('animate-click'), 300);
            const label = dataRanges[chartId].label;
            showGraphFor(chartId, label);
          });
        });

        // ì´ˆê¸° ë¹ˆ ê·¸ë˜í”„ ì„¤ì •
        const ctx = document.getElementById('aihubGraph').getContext('2d');
        realtimeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'ë°ì´í„° ì—†ìŒ',
              data: [],
              borderColor: '#4A90E2',
              backgroundColor: 'rgba(74, 144, 226, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { title: { display: true, text: 'ì‹¤ì‹œê°„ ë°ì´í„°', color: '#ffffff', font: { size: 14 } }, ticks: { color: '#ffffff', font: { size: 12 } } },
              y: { ticks: { color: '#ffffff', font: { size: 12 }, padding: 10 } }
            },
            plugins: {
              legend: { display: false },
              title: { display: true, color: '#ffffff', font: { size: 16 }, padding: { top: 10, bottom: 20 } }
            }
          }
        });

        function showGraphFor(chartId, label) {
          const ctx = document.getElementById('aihubGraph').getContext('2d');
          const valueKeyMap = {
            'chart-1': 'waterPh', 'chart-2': 'waterDo', 'chart-3': 'waterTemp',
            'chart-4': 'waterSalt', 'chart-5': 'waterAmmonia', 'chart-6': 'waterNitrogen'
          };
          const dataKey = valueKeyMap[chartId];

          if (realtimeChart) realtimeChart.destroy();

          realtimeChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labelsMap[chartId],
              datasets: [{
                label: `${label} ì‹¤ì‹œê°„ ë°ì´í„°`,
                data: valuesMap[chartId],
                borderColor: '#66BB6A',
                backgroundColor: 'rgba(102, 187, 106, 0.2)',
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: { title: { display: true, text: 'ì‹¤ì‹œê°„ ë°ì´í„°', color: '#ffffff', font: { size: 14 } }, ticks: { color: '#ffffff', font: { size: 12 } } },
                y: { ticks: { color: '#ffffff', font: { size: 12 } } }
              },
              plugins: {
                legend: { display: false },
                title: { display: true, text: label, color: '#ffffff', font: { size: 16 }, padding: { top: 10, bottom: 20 } }
              }
            }
          });

          fetchLatestTankDataForGraph(chartId, dataKey, labelsMap[chartId], valuesMap[chartId], realtimeChart);
          if (window.graphInterval) clearInterval(window.graphInterval);
          window.graphInterval = setInterval(() => {
            fetchLatestTankDataForGraph(chartId, dataKey, labelsMap[chartId], valuesMap[chartId], realtimeChart);
          }, 1000);
        }

        function fetchLatestTankDataForGraph(chartId, dataKey, labels, values, chart) {
          const urlParams = new URLSearchParams(window.location.search);
          const tankIdx = urlParams.get("tankIdx");

          if (tankIdx) {
            fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
              .then(response => response.json())
              .then(data => {
                const value = parseFloat(data[dataKey]);
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();

                if (!isNaN(value)) {
                  // labelsMapê³¼ valuesMapì— ë°ì´í„° ì¶”ê°€
                  labels.push(timeLabel);
                  values.push(value);

                  // ìµœëŒ€ 10ê°œ ë°ì´í„°ë§Œ ìœ ì§€
                  if (labels.length > 10) {
                    labels.shift();
                    values.shift();
                  }

                  // chartIdì— ë”°ë¼ ranges ë°°ì—´ì˜ ì¸ë±ìŠ¤ ë§¤í•‘
                  const chartIndexMap = {
                    'chart-1': 0, // ì‚°ì„±ë„
                    'chart-2': 1, // ìš©ì¡´ì‚°ì†Œ
                    'chart-3': 2, // ìˆ˜ì˜¨
                    'chart-4': 3, // ì—¼ë„
                    'chart-5': 4, // ì•”ëª¨ë‹ˆì•„
                    'chart-6': 5  // ì•„ì§ˆì‚°
                  };
                  const rangeIndex = chartIndexMap[chartId];
                  const range = ranges[rangeIndex];

                  // ê²½ê³  ìƒíƒœ í™•ì¸
                  const colors = getColor(value, range);

               // ê·¸ë˜í”„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½)
                  chart.data.datasets[0].borderColor = colors.status === 'warning' ? '#E57373' : '#66BB6A';
                  chart.data.datasets[0].backgroundColor = colors.status === 'warning' ? 'rgba(229, 115, 115, 0.2)' : 'rgba(102, 187, 106, 0.2)';

                  // ê·¸ë˜í”„ ë°ì´í„° ì—…ë°ì´íŠ¸
                  chart.data.labels = labels;
                  chart.data.datasets[0].data = values;
                  chart.update();
                } else {
                  console.warn(`Invalid value for ${dataKey}: ${data[dataKey]}`);
                  // ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šì„ ê²½ìš° ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                  const rangeIndex = chartIndexMap[chartId];
                  const range = ranges[rangeIndex];
                  const defaultValue = (range.normalMin + range.normalMax) / 2;
                  labels.push(timeLabel);
                  values.push(defaultValue);

                  if (labels.length > 10) {
                    labels.shift();
                    values.shift();
                  }

                  const colors = getColor(defaultValue, range);
                  
                  // ê·¸ë˜í”„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½)
                  chart.data.datasets[0].borderColor = colors.status === 'warning' ? '#E57373' : '#66BB6A';
                  chart.data.datasets[0].backgroundColor = colors.status === 'warning' ? 'rgba(229, 115, 115, 0.2)' : 'rgba(102, 187, 106, 0.2)';

                  chart.data.labels = labels;
                  chart.data.datasets[0].data = values;
                  chart.update();
                }
              })
              .catch(err => {
                console.error("âŒ ê·¸ë˜í”„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err);
                // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();
                const chartIndexMap = {
                  'chart-1': 0,
                  'chart-2': 1,
                  'chart-3': 2,
                  'chart-4': 3,
                  'chart-5': 4,
                  'chart-6': 5
                };
                const rangeIndex = chartIndexMap[chartId];
                const range = ranges[rangeIndex];
                const defaultValue = (range.normalMin + range.normalMax) / 2;

                labels.push(timeLabel);
                values.push(defaultValue);

                if (labels.length > 10) {
                  labels.shift();
                  values.shift();
                }

                const colors = getColor(defaultValue, range);
                // ê·¸ë˜í”„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ìì—°ìŠ¤ëŸ¬ìš´ ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½)
                chart.data.datasets[0].borderColor = colors.status === 'warning' ? '#E57373' : '#66BB6A';
                chart.data.datasets[0].backgroundColor = colors.status === 'warning' ? 'rgba(229, 115, 115, 0.2)' : 'rgba(102, 187, 106, 0.2)';

                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
              });
          }
        }
      });
    </script>
  </body>
</html>