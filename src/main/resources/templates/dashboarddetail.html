<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ìƒˆìš°ì–‘ì‹ ê´€ì œì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ" />
    <link rel="stylesheet" href="/css/dashboarddetail.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ê´€ì œì„¼í„° ëŒ€ì‹œë³´ë“œ</title>
  </head>
  <body>

<!-- í–„ë²„ê±° ë²„íŠ¼ -->
    <button class="hamburger-btn" id="hamburgerBtn">â˜°</button>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ë©”ë‰´</h2>
      </div>
      <ul class="sidebar-menu">
        <!-- í™ˆ -->
        <li>
          <a href="/maindashboard" class="toggle-menu">í™ˆ</a>
        </li>
        <!-- ìˆ˜ì¡° ì •ë³´ ë“±ë¡ -->
        <li>
          <a href="/tank" class="toggle-menu">ìˆ˜ì¡° ì •ë³´ ë“±ë¡</a>
        </li>
        <!-- ì•ŒëŒ íˆìŠ¤í† ë¦¬ -->
        <li>
          <a href="/alarmHistory2" class="toggle-menu">ì•ŒëŒ íˆìŠ¤í† ë¦¬</a>
        </li>
        <!-- íšŒì› ì •ë³´ ê´€ë¦¬ -->
        <li>
          <a href="javascript:void(0)" class="toggle-menu">íšŒì› ì •ë³´ ê´€ë¦¬</a>
          <ul class="sub-menu">
            <li><a th:href="@{/edit/{id}(id=${session.loginUser.userId})}">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="/delete">íšŒì› íƒˆí‡´</a></li>
          </ul>
        </li>
      </ul>
    </div>

      <!-- ë©”ì¸ ì½˜í…ì¸  -->
      <main class="main-content">
        <header class="header">
          <h1 class="page-title">ì„¸ë¶€ê´€ì œì‹œìŠ¤í…œ</h1>
          
          <div class="user-info">
          
            <div th:if="${session.loginUser != null}">
    		<p th:text="${session.loginUser.userId}"></p> <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë¦„ ì¶œë ¥ -->
		  </div>
		    <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button> <!-- âœ… ìˆ˜ì •ëœ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
          </div>
          </div>
        </header>

        <!-- 6ê°œì˜ ë°ì´í„° ì¹´ë“œ -->
        <!-- ë°ì´í„° í‘œì‹œ -->
		<section class="dashboard-cards">
		    <!-- ì‚°ì„±ë„ -->
		    <div class="card card-ph">
		        <h4>ì‚°ì„±ë„</h4>
		        <div class="data-container">
		            <div id="phValue" class="data-box">-</div>
		            <canvas id="chart-1" width="200" height="200"></canvas>
		        </div>
		    </div>
		
		    <!-- ìš©ì¡´ì‚°ì†Œ -->
		    <div class="card card-oxygen">
		        <h4>ìš©ì¡´ì‚°ì†Œ</h4>
		        <div class="data-container">
		            <div id="oxygenValue" class="data-box">-</div>
		            <canvas id="chart-2" width="200" height="200"></canvas>
		        </div>
		    </div>
		
		    <!-- ìˆ˜ì˜¨ -->
		    <div class="card card-temperature">
		        <h4>ìˆ˜ì˜¨</h4>
		        <div class="data-container">
		            <div id="temperatureValue" class="data-box">-</div>
		            <canvas id="chart-3" width="200" height="200"></canvas>
		        </div>
		    </div>
		
		    <!-- ì—¼ë„ -->
		    <div class="card card-salinity">
		        <h4>ì—¼ë„</h4>
		        <div class="data-container">
		            <div id="salinityValue" class="data-box">-</div>
		            <canvas id="chart-4" width="200" height="200"></canvas>
		        </div>
		    </div>
		
		    <!-- ì•”ëª¨ë‹ˆì•„ -->
		    <div class="card card-ammonia">
		        <h4>ì•”ëª¨ë‹ˆì•„</h4>
		        <div class="data-container">
		            <div id="ammoniaValue" class="data-box">-</div>
		            <canvas id="chart-5" width="200" height="200"></canvas>
		        </div>
		    </div>
		
		    <!-- ì•„ì§ˆì‚° -->
		    <div class="card card-nitrite">
		        <h4>ì•„ì§ˆì‚°</h4>
		        <div class="data-container">
		            <div id="nitriteValue" class="data-box">-</div>
		            <canvas id="chart-6" width="200" height="200"></canvas>
		        </div>
		    </div>
		</section>


        <!-- ìˆ˜ì¡°ì •ë³´ì™€ ì‹¤ì‹œê°„ ê·¸ë˜í”„ -->
        <section class="dashboard-cards">
		    <div class="tank-info">
			    <h4>ìˆ˜ì¡°ì •ë³´</h4><br>
			    <p><strong>ìˆ˜ì¡° ID:</strong> <span th:text="${selectedTank?.tankIdx ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
			    <p><strong>ì§ê²½:</strong> <span th:text="${selectedTank?.tankWidth ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
			    <p><strong>ë†’ì´:</strong> <span th:text="${selectedTank?.tankHeight ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
			    <p><strong>ìœ„ì¹˜:</strong> <span th:text="${selectedTank?.tankLocation ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
			    <p><strong>í’ˆì¢…:</strong> <span th:text="${selectedTank?.fishType ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
			    <p><strong>ì‚¬ìœ¡ ê°œì‹œì¼:</strong><span th:text="${selectedTank?.startedAt != null ? #temporals.format(selectedTank.startedAt, 'yyyy-MM-dd') : 'ì •ë³´ ì—†ìŒ'}"></span></p>
			    <canvas id="tank-data"></canvas>
			</div>
			<div class="card card-graph">
            <div class="graph-container" >
              <!-- AI í—ˆë¸Œ ë°ì´í„°ë¥¼ í™œìš©í•œ ê·¸ë˜í”„ ì‚½ì… ì˜ì—­ /30ì´ˆë§ˆë‹¤ ë³€ê²½ë˜ê²Œ -->
              <canvas id="aihubGraph"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>

        <script>
        /**
         * ğŸ”¹ ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (ì¿ í‚¤ ì‚­ì œ í›„ ì„œë²„ ìš”ì²­)
         */
        function handleLogout() {
            console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");

            // âœ… ìë™ ë¡œê·¸ì¸ ê´€ë ¨ ì¿ í‚¤ ì‚­ì œ
            deleteCookie("autoLoginId");
            deleteCookie("autoLoginPw");

            // âœ… ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ë³´ë‚´ê¸°
            fetch("/logout", { method: "GET" })
                .then(() => {
                    alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
                    window.location.href = "/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                });
        }

        /**
         * ğŸ”¹ ì¿ í‚¤ ì‚­ì œ í•¨ìˆ˜
         */
        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict;Secure`;
        }

     // í–„ë²„ê±° ë²„íŠ¼ìœ¼ë¡œ ì‚¬ì´ë“œë°” í† ê¸€
        hamburgerBtn.addEventListener("click", () => {
          sidebar.classList.toggle("active");
        });

        // ì„œë¸Œ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
        const toggleMenus = document.querySelectorAll(".toggle-menu");
        toggleMenus.forEach(menu => {
          menu.addEventListener("click", (e) => {
            const subMenu = menu.nextElementSibling;
            if (subMenu && subMenu.classList.contains("sub-menu")) {
              e.preventDefault(); // ë§í¬ ê¸°ë³¸ ë™ì‘ ë°©ì§€
              subMenu.style.display = subMenu.style.display === "block" ? "none" : "block";
            }
          });
        });


        // ì•Œë¦¼ ë¡œê·¸
		        function toggleNotifications() {
		  var log = document.getElementById("notificationLog");
		  log.style.display = log.style.display === "block" ? "none" : "block";
		}

        
     // "ìˆ˜ì¡° ê´€ë¦¬"ì™€ "íšŒì› ì •ë³´ ê´€ë¦¬"ë¥¼ í´ë¦­í•  ë•Œ sub-menu ì—´ê¸°
        document.querySelectorAll('.toggle-menu').forEach(menu => {
          menu.addEventListener('click', function() {
            const subMenu = this.nextElementSibling; // í´ë¦­ëœ í•­ëª© ë°”ë¡œ ë‹¤ìŒì˜ ul.sub-menu

            // ì´ë¯¸ ì—´ë ¤ ìˆëŠ” ê²½ìš° ìˆ¨ê¸°ê¸°
            if (subMenu.classList.contains('open')) {
              subMenu.classList.remove('open');
            } else {
              // ë‹¤ë¥¸ ë©”ë‰´ë“¤ì€ ë‹«íˆê²Œ í•¨
              document.querySelectorAll('.sub-menu').forEach(menu => {
                menu.classList.remove('open');
              });

              // í´ë¦­ëœ ë©”ë‰´ë§Œ ì—´ê¸°
              subMenu.classList.add('open');
            }
          });
        });


        // Get canvas elements for each chart
        const canvasElements = [
          document.getElementById('chart-1'),
          document.getElementById('chart-2'),
          document.getElementById('chart-3'),
          document.getElementById('chart-4'),
          document.getElementById('chart-5'),
          document.getElementById('chart-6'),
        ];

        // ë°ì´í„° ë²”ìœ„ ë° ì´ˆê¸°ê°’ ì„¤ì •
        const dataRanges = {
          'chart-1': { min: 6.5, max: 8.5, initial: 7.5, label: 'pH' }, // ì‚°ì„±ë„
          'chart-2': { min: 4.0, max: 8.0, initial: 6.0, label: 'Oâ‚‚ (mg/L)' }, // ìš©ì¡´ì‚°ì†Œ
          'chart-3': { min: 20.0, max: 30.0, initial: 25.0, label: 'Â°C' }, // ìˆ˜ì˜¨
          'chart-4': { min: 10.0, max: 35.0, initial: 20.0, label: 'ppt' }, // ì—¼ë„
          'chart-5': { min: 0.0, max: 2.0, initial: 0.5, label: 'NHâ‚ƒ (mg/L)' }, // ì•”ëª¨ë‹ˆì•„
          'chart-6': { min: 0.0, max: 1.0, initial: 0.2, label: 'NOâ‚‚ (mg/L)' }, // ì•„ì§ˆì‚°
        };
        

        // ê° ìº”ë²„ìŠ¤ë³„ í˜„ì¬ ê°’ê³¼ ì•Œë¦¼ ìƒíƒœ ì €ì¥
        const currentValues = {
          'chart-1': dataRanges['chart-1'].initial,
          'chart-2': dataRanges['chart-2'].initial,
          'chart-3': dataRanges['chart-3'].initial,
          'chart-4': dataRanges['chart-4'].initial,
          'chart-5': dataRanges['chart-5'].initial,
          'chart-6': dataRanges['chart-6'].initial,
        };
        const alertStates = {
          'chart-1': false,
          'chart-2': false,
          'chart-3': false,
          'chart-4': false,
          'chart-5': false,
          'chart-6': false,
        };
        
        //---------------------[ìµœì‹  ìˆ˜ì§ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë°±ì—”ë“œ ìŠ¤í¬ë¦½íŠ¸]----------------------
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const tankIdx = urlParams.get("tankIdx");

            if (tankIdx) {
                fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`âŒ HTTP ì˜¤ë¥˜: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("âœ… ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", data);

                        document.getElementById("phValue").textContent = data.waterPh || "ì •ë³´ ì—†ìŒ";
                        document.getElementById("oxygenValue").textContent = data.waterDo || "ì •ë³´ ì—†ìŒ";
                        document.getElementById("temperatureValue").textContent = data.waterTemp || "ì •ë³´ ì—†ìŒ";
                        document.getElementById("salinityValue").textContent = data.waterSalt || "ì •ë³´ ì—†ìŒ";
                        document.getElementById("ammoniaValue").textContent = data.waterAmmonia || "ì •ë³´ ì—†ìŒ";
                        document.getElementById("nitriteValue").textContent = data.waterNitrogen || "ì •ë³´ ì—†ìŒ";
                    })
                    .catch(error => {
                        console.error("âŒ ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                    });
            }
        });



        /**
         * ğŸ”¹ ê²Œì´ì§€ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
         * @param {string} chartId - ìº”ë²„ìŠ¤ ID
         * @param {number} value - í˜„ì¬ ê°’
         * @param {number} min - ìµœì†Œê°’
         * @param {number} max - ìµœëŒ€ê°’
         */
         
         //---------------------------------------------í™”ì‚´í‘œ í‘œì‹œ-----------------------------------------------
      document.addEventListener("DOMContentLoaded", function () {
    // ì „ì—­ ë³€ìˆ˜ ì •ì˜
    const canvasElements = [
        document.getElementById('chart-1'),
        document.getElementById('chart-2'),
        document.getElementById('chart-3'),
        document.getElementById('chart-4'),
        document.getElementById('chart-5'),
        document.getElementById('chart-6'),
    ];

    const dataRanges = {
        'chart-1': { min: 0.0, max: 10.0, initial: 7.5, label: 'pH' },
        'chart-2': { min: 0.0, max: 10.0, initial: 6.0, label: 'Oâ‚‚ (mg/L)' },
        'chart-3': { min: 0.0, max: 30.0, initial: 25.0, label: 'Â°C' },
        'chart-4': { min: 0.0, max: 10.0, initial: 20.0, label: 'ppt' },
        'chart-5': { min: 0.0, max: 10.0, initial: 0.5, label: 'NHâ‚ƒ (mg/L)' },
        'chart-6': { min: 0.0, max: 10.0, initial: 0.2, label: 'NOâ‚‚ (mg/L)' },
    };

    const currentValues = {
        'chart-1': dataRanges['chart-1'].initial,
        'chart-2': dataRanges['chart-2'].initial,
        'chart-3': dataRanges['chart-3'].initial,
        'chart-4': dataRanges['chart-4'].initial,
        'chart-5': dataRanges['chart-5'].initial,
        'chart-6': dataRanges['chart-6'].initial,
    };

    // ê° ìº”ë²„ìŠ¤ë³„ í˜„ì¬ ê°ë„ì™€ ëª©í‘œ ê°ë„ ê´€ë¦¬
    const angles = {
        'chart-1': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-2': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-3': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-4': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-5': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-6': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
    };

    // ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ìƒíƒœ ê´€ë¦¬
    const animationStates = {
        'chart-1': { animating: false },
        'chart-2': { animating: false },
        'chart-3': { animating: false },
        'chart-4': { animating: false },
        'chart-5': { animating: false },
        'chart-6': { animating: false },
    };

    // ì´ì§• í•¨ìˆ˜ (easeOutQuad)
    function easeOutQuad(t) {
        return 1 - (1 - t) * (1 - t);
    }

    // ê²Œì´ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€)
    function updateGauge(chartId, value, min, max) {
        if (value === null || value === undefined || isNaN(value)) {
            console.warn(`updateGauge: ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ - chartId: ${chartId}, value: ${value}`);
            return;
        }

        console.log(`updateGauge í˜¸ì¶œ - chartId: ${chartId}, value: ${value}, min: ${min}, max: ${max}`);

        const percentage = ((value - min) / (max - min)) * 100;
        const targetAngle = Math.PI + (percentage / 100) * Math.PI;
        angles[chartId].target = targetAngle;

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        if (!animationStates[chartId].animating) {
            animationStates[chartId].animating = true;
            animateGauge(chartId);
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    function animateGauge(chartId) {
        const canvas = document.getElementById(chartId);
        const ctx = canvas.getContext("2d");
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        const startAngle = angles[chartId].current;
        const targetAngle = angles[chartId].target;
        const duration = 1000; // ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ (1ì´ˆ)
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1); // 0ì—ì„œ 1ê¹Œì§€ ì§„í–‰
            const easedProgress = easeOutQuad(progress);

            // í˜„ì¬ ê°ë„ë¥¼ ëª©í‘œ ê°ë„ë¡œ ë³´ê°„
            angles[chartId].current = startAngle + (targetAngle - startAngle) * easedProgress;

            // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // ë°°ê²½ ê²Œì´ì§€ ê·¸ë¦¬ê¸°
            drawGaugeOnCanvas(chartId, canvas);

            // í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight - 50;
            const len = 80;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(angles[chartId].current) * len, centerY + Math.sin(angles[chartId].current) * len);
            ctx.strokeStyle = '#4A90E2';
            ctx.lineWidth = 4;
            ctx.stroke();

            // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ ê³„ì† ì§„í–‰
            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                animationStates[chartId].animating = false;
            }
        }

        requestAnimationFrame(step);
    }

    // ê²Œì´ì§€ ë°°ê²½ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function drawGaugeOnCanvas(canvasId, canvas) {
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight - 50;
        const radius = 100;
        const gaugeWidth = 30;

        const colors = {
            normal: '#A2E1DB',
            warning: '#FFDBCC',
            danger: '#FCB9AA'
        };

        const fixedData = {
            normal: 33,
            warning: 33,
            danger: 34
        };

        const labels = {
            normal: 'ì •ìƒ',
            warning: 'ê²½ê³ ',
            danger: 'ìœ„í—˜'
        };

        function drawGauge() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            const totalAngle = Math.PI;
            const startAngle = Math.PI;
            const total = fixedData.normal + fixedData.warning + fixedData.danger;
            const normalAngle = (fixedData.normal / total) * totalAngle;
            const warningAngle = (fixedData.warning / total) * totalAngle;
            const dangerAngle = (fixedData.danger / total) * totalAngle;

            let currentAngle = startAngle;

            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + normalAngle);
            ctx.lineTo(centerX + Math.cos(currentAngle + normalAngle) * (radius - gaugeWidth), centerY + Math.sin(currentAngle + normalAngle) * (radius - gaugeWidth));
            ctx.arc(centerX, centerY, radius - gaugeWidth, currentAngle + normalAngle, currentAngle, true);
            ctx.closePath();
            ctx.fillStyle = colors.normal;
            ctx.fill();

            currentAngle += normalAngle;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + warningAngle);
            ctx.lineTo(centerX + Math.cos(currentAngle + warningAngle) * (radius - gaugeWidth), centerY + Math.sin(currentAngle + warningAngle) * (radius - gaugeWidth));
            ctx.arc(centerX, centerY, radius - gaugeWidth, currentAngle + warningAngle, currentAngle, true);
            ctx.closePath();
            ctx.fillStyle = colors.warning;
            ctx.fill();

            currentAngle += warningAngle;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + dangerAngle);
            ctx.lineTo(centerX + Math.cos(currentAngle + dangerAngle) * (radius - gaugeWidth), centerY + Math.sin(currentAngle + dangerAngle) * (radius - gaugeWidth));
            ctx.arc(centerX, centerY, radius - gaugeWidth, currentAngle + dangerAngle, currentAngle, true);
            ctx.closePath();
            ctx.fillStyle = colors.danger;
            ctx.fill();

            drawLabels(startAngle, normalAngle, warningAngle, dangerAngle);
        }

        function drawLabels(startAngle, normalAngle, warningAngle, dangerAngle) {
            const labelRadius = radius - gaugeWidth / 2;
            ctx.fillStyle = 'black';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const angles = [
                startAngle + normalAngle / 2,
                startAngle + normalAngle + warningAngle / 2,
                startAngle + normalAngle + warningAngle + dangerAngle / 2
            ];
            const texts = [labels.normal, labels.warning, labels.danger];

            angles.forEach((angle, i) => {
                const x = centerX + Math.cos(angle) * labelRadius;
                const y = centerY + Math.sin(angle) * labelRadius;
                ctx.fillText(texts[i], x, y);
            });
        }

        drawGauge();
    }

    // ì´ˆê¸° ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
    canvasElements.forEach(canvas => {
        drawGaugeOnCanvas(canvas.id, canvas);
    });

    // ì‹¤ì‹œê°„ ê·¸ë˜í”„ ìº”ë²„ìŠ¤ (ë¹ˆ ìƒíƒœ ìœ ì§€)
    const aihubGraph = document.getElementById('aihubGraph').getContext('2d');

    // ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function fetchLatestTankData() {
        const urlParams = new URLSearchParams(window.location.search);
        const tankIdx = urlParams.get("tankIdx");

        if (tankIdx) {
            console.log(`fetchLatestTankData í˜¸ì¶œ - tankIdx: ${tankIdx}`);
            fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
                .then(response => response.json())
                .then(data => {
                    console.log("âœ… ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", data);

                    // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    document.getElementById("phValue").textContent = data.waterPh || "ì •ë³´ ì—†ìŒ";
                    document.getElementById("oxygenValue").textContent = data.waterDo || "ì •ë³´ ì—†ìŒ";
                    document.getElementById("temperatureValue").textContent = data.waterTemp || "ì •ë³´ ì—†ìŒ";
                    document.getElementById("salinityValue").textContent = data.waterSalt || "ì •ë³´ ì—†ìŒ";
                    document.getElementById("ammoniaValue").textContent = data.waterAmmonia || "ì •ë³´ ì—†ìŒ";
                    document.getElementById("nitriteValue").textContent = data.waterNitrogen || "ì •ë³´ ì—†ìŒ";

                    // currentValues ì—…ë°ì´íŠ¸ ë° ë””ë²„ê¹… ë¡œê·¸
                    currentValues['chart-1'] = parseFloat(data.waterPh) || currentValues['chart-1'];
                    currentValues['chart-2'] = parseFloat(data.waterDo) || currentValues['chart-2'];
                    currentValues['chart-3'] = parseFloat(data.waterTemp) || currentValues['chart-3'];
                    currentValues['chart-4'] = parseFloat(data.waterSalt) || currentValues['chart-4'];
                    currentValues['chart-5'] = parseFloat(data.waterAmmonia) || currentValues['chart-5'];
                    currentValues['chart-6'] = parseFloat(data.waterNitrogen) || currentValues['chart-6'];
                    console.log("ì—…ë°ì´íŠ¸ëœ currentValues:", currentValues);

                    // í™”ì‚´í‘œ ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
                    updateGauge('chart-1', currentValues['chart-1'], dataRanges['chart-1'].min, dataRanges['chart-1'].max);
                    updateGauge('chart-2', currentValues['chart-2'], dataRanges['chart-2'].min, dataRanges['chart-2'].max);
                    updateGauge('chart-3', currentValues['chart-3'], dataRanges['chart-3'].min, dataRanges['chart-3'].max);
                    updateGauge('chart-4', currentValues['chart-4'], dataRanges['chart-4'].min, dataRanges['chart-4'].max);
                    updateGauge('chart-5', currentValues['chart-5'], dataRanges['chart-5'].min, dataRanges['chart-5'].max);
                    updateGauge('chart-6', currentValues['chart-6'], dataRanges['chart-6'].min, dataRanges['chart-6'].max);
                })
                .catch(error => {
                    console.error("âŒ ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
                });
        } else {
            console.warn("tankIdxê°€ URLì— ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // í˜ì´ì§€ ë¡œë“œ í›„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘
    fetchLatestTankData();

    // 5ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  (30ì´ˆì—ì„œ 5ì´ˆë¡œ ì¤„ì—¬ì„œ í…ŒìŠ¤íŠ¸ ìš©ì´í•˜ê²Œ)
    setInterval(fetchLatestTankData, 1000*60*60*24);
});

			//---------------------[ìµœì‹  ìˆ˜ì§ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ìë™ ìƒˆë¡œê³ ì¹¨ ë°±ì—”ë“œ ìŠ¤í¬ë¦½íŠ¸]------------------------
			/**
			 * ğŸ”¹ ì¼ì • ì£¼ê¸°ë§ˆë‹¤ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ìë™ ê°±ì‹ )
			 */
			function startAutoRefresh() {
			    console.log("â³ ìë™ ê°±ì‹  ì‹œì‘ (10ì´ˆ ê°„ê²©)");
			
			    // âœ… ìµœì´ˆ ì‹¤í–‰ (í˜ì´ì§€ ë¡œë”© í›„ ì¦‰ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°)
			    fetchLatestTankData();
			
			    // âœ… 10ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  (10000ms = 10ì´ˆ)
			    setInterval(fetchLatestTankData, 1000*60*60*24);
			}
			
			// âœ… í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ ìë™ ê°±ì‹  ì‹œì‘
			document.addEventListener("DOMContentLoaded", startAutoRefresh);
			//-------------------------------------------------------------------------------
			
			
			// í´ë¦­ ì´ë²¤íŠ¸ ë° ì‹¤ì‹œê°„ ë°ì´í„° -ì„±ê¶Œ-
			// ì¹´ë“œ ìš”ì†Œë“¤ì„ ì„ íƒ
		const cardElements = document.querySelectorAll('.card');

			// ê° ì¹´ë“œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
			cardElements.forEach(card => {
			  card.addEventListener('click', () => {
			    // ëª¨ë“  ì¹´ë“œì˜ í´ë¦­ ìƒíƒœ ì´ˆê¸°í™”
			    cardElements.forEach(c => {
			      c.classList.remove('clicked', 'animate-click');
			    });
			
			    // í´ë¦­ëœ ì¹´ë“œì— íš¨ê³¼ ì ìš©
			    card.classList.add('clicked', 'animate-click');
			
			    // ì• ë‹ˆë©”ì´ì…˜ í›„ 'animate-click' ì œê±° (300ms)
			    setTimeout(() => {
			      card.classList.remove('animate-click');
			    }, 300);
			
			    // ê¸°ì¡´ ê·¸ë˜í”„ í‘œì‹œ ë¡œì§
			    const canvas = card.querySelector('canvas'); // ì¹´ë“œ ë‚´ì˜ ìº”ë²„ìŠ¤ ìš”ì†Œ
			    const chartId = canvas.id; // ìº”ë²„ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
			    const label = dataRanges[chartId].label; // í•´ë‹¹ IDì— ë§ëŠ” ë¼ë²¨
			    showGraphFor(chartId, label); // ê·¸ë˜í”„ ì¶œë ¥ í•¨ìˆ˜ í˜¸ì¶œ
			  });
			});
			
			let realtimeChart = null; // í˜„ì¬ ê·¸ë˜í”„ ì €ì¥ìš©
			
			// â˜…â˜…â˜… ì—¬ê¸°ì—ì„œ ì´ˆê¸° ë¹ˆ ê·¸ë˜í”„ë¥¼ ì„¤ì • â˜…â˜…â˜…
			window.onload = function() {
			  const ctx = document.getElementById('aihubGraph').getContext('2d');

			  // ì´ˆê¸° ë¹ˆ ê·¸ë˜í”„ ìƒì„±
			  realtimeChart = new Chart(ctx, {
			    type: 'line',
			    data: {
			      labels: [],
			      datasets: [{
			        label: 'ë°ì´í„° ì—†ìŒ',
			        data: [],
			        borderColor: '#4A90E2',
			        backgroundColor: 'rgba(74, 144, 226, 0.2)',
			        fill: true,
			        tension: 0.3
			      }]
			    },
			    options: {
			      responsive: true,
			      maintainAspectRatio: false,
			      scales: {
			        x: {
			          title: {
			            display: true,
			            text: 'ì‹¤ì‹œê°„ ë°ì´í„°',
			            color: '#ffffff',
			            font: { size: 14 }
			          },
			          ticks: { display: true, color: '#ffffff', font: { size: 12 } }
			        },
			        y: {
			          title: { display: false },
			          ticks: { color: '#ffffff', font: { size: 12 },
			          padding: 10
			          }
			        }
			      },
			      plugins: {
			        legend: { display: false },
			        title: {
			          display: true,
			          color: '#ffffff',
			          font: { size: 16 },
			          padding: { top: 10, bottom: 20 }
			        }
			      }
			    }
			  });
			};
			// â˜…â˜…â˜… ì´ˆê¸°í™” ì½”ë“œ ë â˜…â˜…â˜…
			
			// â–¶ ê·¸ë˜í”„ ì¶œë ¥ í•¨ìˆ˜
			function showGraphFor(chartId, label) {
			  const ctx = document.getElementById('aihubGraph').getContext('2d');
			  const valueKeyMap = {
			    'chart-1': 'waterPh',
			    'chart-2': 'waterDo',
			    'chart-3': 'waterTemp',
			    'chart-4': 'waterSalt',
			    'chart-5': 'waterAmmonia',
			    'chart-6': 'waterNitrogen'
			  };
			  const dataKey = valueKeyMap[chartId];
			
			  let labels = [];
			  let values = [];
			
			  // ê¸°ì¡´ ê·¸ë˜í”„ ì œê±°
			  if (realtimeChart) {
			    realtimeChart.destroy();
			  }
			
			  // ìƒˆ ê·¸ë˜í”„ ìƒì„±
			  realtimeChart = new Chart(ctx, {
			    type: 'line',
			    data: {
			      labels: labels, // Xì¶• ë ˆì´ë¸” (ì‹œê°„ ë“±)
			      datasets: [{
			        label: `${label} ì‹¤ì‹œê°„ ë°ì´í„°`, // ë²”ë¡€ ë ˆì´ë¸”
			        data: values,
			        borderColor: '#4A90E2',
			        backgroundColor: 'rgba(74, 144, 226, 0.2)',
			        fill: true,
			        tension: 0.3
			      }]
			    },
			    options: {
			      responsive: true,
			      maintainAspectRatio: false, // ì¢…íš¡ë¹„ ìœ ì§€ ë¹„í™œì„±í™”
			      scales: {
			        x: {
			          title: {
			            display: true,
			            text: 'ì‹¤ì‹œê°„ ë°ì´í„°',
			            color: '#ffffff',
			            font: {
			              size: 14
			            }
			          },
			          ticks: {
			            display: true, // Xì¶• ë ˆì´ë¸” í‘œì‹œ ìœ ì§€
			            color: '#ffffff',
			            font: {
			              size: 12
			            }
			          }
			        },
			        y: {
			          title: {
			            display: false // Yì¶• ì œëª© ìˆ¨ê¹€
			          },
			          ticks: {
			            color: '#ffffff',
			            font: {
			              size: 12
			            }
			          }
			        }
			      },
			      plugins: {
			        legend: {
			          display: false // ë²”ë¡€(ë°ì´í„°ì…‹ì˜ label)ë¥¼ ìˆ¨ê¹€
			        },
			        title: {
			          display: true,
			          text: label, // Yì¶• ì œëª©("pH")ì„ ìƒë‹¨ì— í‘œì‹œ
			          color: '#ffffff',
			          font: {
			            size: 16
			          },
			          padding: {
			            top: 10,
			            bottom: 20
			          }
			        }
			      }
			    }
			  });

			  // ì¦‰ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° + 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
			  fetchLatestTankDataForGraph(dataKey, labels, values, realtimeChart);
			  setInterval(() => {
			    fetchLatestTankDataForGraph(dataKey, labels, values, realtimeChart);
			  }, 1000*60*60*24); // ê°±ì‹ 
			}
			// â–¶ ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ ê·¸ë˜í”„ ê°±ì‹ 
			function fetchLatestTankDataForGraph(dataKey, labels, values, chart) {
			  const urlParams = new URLSearchParams(window.location.search);
			  const tankIdx = urlParams.get("tankIdx");

			  if (tankIdx) {
			    fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
			      .then(response => response.json())
			      .then(data => {
			        const value = data[dataKey];
			        const now = new Date();
			        const timeLabel = now.toLocaleTimeString();

			        if (value !== null && value !== undefined) {
			          labels.push(timeLabel);
			          values.push(value);

			          if (labels.length > 10) { // 10ê°œê¹Œì§€ë§Œ ìœ ì§€
			            labels.shift();
			            values.shift();
			          }

			          chart.update();
			        }
			      })
			      .catch(err => console.error("âŒ ê·¸ë˜í”„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));
			  }
			}

			
			
			
    </script>


  </body>
</html>