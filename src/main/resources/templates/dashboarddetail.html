<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ìƒˆìš°ì–‘ì‹ ê´€ì œì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ" />
    <link rel="stylesheet" href="/css/dashboarddetail.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ê´€ì œì„¼í„° ëŒ€ì‹œë³´ë“œ</title>
  </head>
  <body>
    <!-- í–„ë²„ê±° ë²„íŠ¼ -->
    <button class="hamburger-btn" id="hamburgerBtn">â˜°</button>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ë©”ë‰´</h2>
      </div>
      <ul class="sidebar-menu">
        <!-- í™ˆ -->
        <li>
          <a href="/maindashboard" class="toggle-menu">í™ˆ</a>
        </li>
        <!-- ìˆ˜ì¡° ì •ë³´ ë“±ë¡ -->
        <li>
          <a href="/tank" class="toggle-menu">ìˆ˜ì¡° ì •ë³´ ë“±ë¡</a>
        </li>
        <!-- ì•ŒëŒ íˆìŠ¤í† ë¦¬ -->
        <li>
          <a href="/alarmHistory2" class="toggle-menu">ì•ŒëŒ íˆìŠ¤í† ë¦¬</a>
        </li>
        <!-- íšŒì› ì •ë³´ ê´€ë¦¬ -->
        <li>
          <a href="javascript:void(0)" class="toggle-menu">íšŒì› ì •ë³´ ê´€ë¦¬</a>
          <ul class="sub-menu">
            <li><a th:href="@{/edit/{id}(id=${session.loginUser.userId})}">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="/delete">íšŒì› íƒˆí‡´</a></li>
          </ul>
        </li>
      </ul>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <header class="header">
        <h1 class="page-title">ì„¸ë¶€ê´€ì œì‹œìŠ¤í…œ</h1>
        <div class="user-info">
          <div th:if="${session.loginUser != null}">
            <p th:text="${session.loginUser.userId}"></p> <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë¦„ ì¶œë ¥ -->
          </div>
          <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button> <!-- âœ… ìˆ˜ì •ëœ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
        </div>
      </header>

      <!-- 6ê°œì˜ ë°ì´í„° ì¹´ë“œ -->
      <!-- ë°ì´í„° í‘œì‹œ -->
      <section class="dashboard-cards">
        <!-- ì‚°ì„±ë„ -->
        <div class="card card-ph">
          <h4>ì‚°ì„±ë„</h4>
          <div class="data-container">
            <canvas id="chart-1" width="200" height="200"></canvas>
          </div>
        </div>

        <!-- ìš©ì¡´ì‚°ì†Œ -->
        <div class="card card-oxygen">
          <h4>ìš©ì¡´ì‚°ì†Œ</h4>
          <div class="data-container">
            <canvas id="chart-2" width="200" height="200"></canvas>
          </div>
        </div>

        <!-- ìˆ˜ì˜¨ -->
        <div class="card card-temperature">
          <h4>ìˆ˜ì˜¨</h4>
          <div class="data-container">
            <canvas id="chart-3" width="200" height="200"></canvas>
          </div>
        </div>

        <!-- ì—¼ë„ -->
        <div class="card card-salinity">
          <h4>ì—¼ë„</h4>
          <div class="data-container">
            <canvas id="chart-4" width="200" height="200"></canvas>
          </div>
        </div>

        <!-- ì•”ëª¨ë‹ˆì•„ -->
        <div class="card card-ammonia">
          <h4>ì•”ëª¨ë‹ˆì•„</h4>
          <div class="data-container">
            <canvas id="chart-5" width="200" height="200"></canvas>
          </div>
        </div>

        <!-- ì•„ì§ˆì‚° -->
        <div class="card card-nitrite">
          <h4>ì•„ì§ˆì‚°</h4>
          <div class="data-container">
            <canvas id="chart-6" width="200" height="200"></canvas>
          </div>
        </div>
      </section>

      <!-- ìˆ˜ì¡°ì •ë³´ì™€ ì‹¤ì‹œê°„ ê·¸ë˜í”„ -->
      <section class="dashboard-cards">
        <div class="tank-info">
          <h4>ìˆ˜ì¡°ì •ë³´</h4><br>
          <p><strong>ìˆ˜ì¡° ID:</strong> <span th:text="${selectedTank?.tankIdx ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>ì§ê²½:</strong> <span th:text="${selectedTank?.tankWidth ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
          <p><strong>ë†’ì´:</strong> <span th:text="${selectedTank?.tankHeight ?: 'ì •ë³´ ì—†ìŒ'}"></span> m</p>
          <p><strong>ìœ„ì¹˜:</strong> <span th:text="${selectedTank?.tankLocation ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>í’ˆì¢…:</strong> <span th:text="${selectedTank?.fishType ?: 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <p><strong>ì‚¬ìœ¡ ê°œì‹œì¼:</strong><span th:text="${selectedTank?.startedAt != null ? #temporals.format(selectedTank.startedAt, 'yyyy-MM-dd') : 'ì •ë³´ ì—†ìŒ'}"></span></p>
          <canvas id="tank-data"></canvas>
        </div>
        <div class="card card-graph">
          <div class="graph-container">
            <!-- AI í—ˆë¸Œ ë°ì´í„°ë¥¼ í™œìš©í•œ ê·¸ë˜í”„ ì‚½ì… ì˜ì—­ /30ì´ˆë§ˆë‹¤ ë³€ê²½ë˜ê²Œ -->
            <canvas id="aihubGraph"></canvas>
          </div>
        </div>
      </section>
    </main>

    <script>
      // ì „ì—­ ë³€ìˆ˜ ì •ì˜
      const dataRanges = {
        'chart-1': { min: 7.5, max: 9.0, label: 'pH' }, // ì‚°ì„±ë„
        'chart-2': { min: 5.0, max: 10.0, label: 'Oâ‚‚ (mg/L)' }, // ìš©ì¡´ì‚°ì†Œ
        'chart-3': { min: 26.0, max: 38.0, label: 'Â°C' }, // ìˆ˜ì˜¨
        'chart-4': { min: 0.5, max: 45.0, label: 'ppt' }, // ì—¼ë„
        'chart-5': { min: 0.0, max: 0.16, label: 'NHâ‚ƒ (mg/L)' }, // ì•”ëª¨ë‹ˆì•„
        'chart-6': { min: 0.0, max: 0.5, label: 'NOâ‚‚ (mg/L)' }, // ì•„ì§ˆì‚°
      };

      let currentValues = {
        'chart-1': null,
        'chart-2': null,
        'chart-3': null,
        'chart-4': null,
        'chart-5': null,
        'chart-6': null,
      };

      let realtimeChart = null; // í˜„ì¬ ê·¸ë˜í”„ ì €ì¥ìš©

      /**
       * ğŸ”¹ ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (ì¿ í‚¤ ì‚­ì œ í›„ ì„œë²„ ìš”ì²­)
       */
      function handleLogout() {
        console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");

        // âœ… ìë™ ë¡œê·¸ì¸ ê´€ë ¨ ì¿ í‚¤ ì‚­ì œ
        deleteCookie("autoLoginId");
        deleteCookie("autoLoginPw");

        // âœ… ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ë³´ë‚´ê¸°
        fetch("/logout", { method: "GET" })
          .then(() => {
            alert("ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
            window.location.href = "/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          });
      }

      /**
       * ğŸ”¹ ì¿ í‚¤ ì‚­ì œ í•¨ìˆ˜
       */
      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict;Secure`;
      }

      // í–„ë²„ê±° ë²„íŠ¼ìœ¼ë¡œ ì‚¬ì´ë“œë°” í† ê¸€
      document.getElementById("hamburgerBtn").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("active");
      });

      // ì„œë¸Œ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
      const toggleMenus = document.querySelectorAll(".toggle-menu");
      toggleMenus.forEach(menu => {
        menu.addEventListener("click", (e) => {
          const subMenu = menu.nextElementSibling;
          if (subMenu && subMenu.classList.contains("sub-menu")) {
            e.preventDefault(); // ë§í¬ ê¸°ë³¸ ë™ì‘ ë°©ì§€
            subMenu.style.display = subMenu.style.display === "block" ? "none" : "block";
          }
        });
      });

      // ì•Œë¦¼ ë¡œê·¸
      function toggleNotifications() {
        var log = document.getElementById("notificationLog");
        if (log) {
          log.style.display = log.style.display === "block" ? "none" : "block";
        }
      }

      // "ìˆ˜ì¡° ê´€ë¦¬"ì™€ "íšŒì› ì •ë³´ ê´€ë¦¬"ë¥¼ í´ë¦­í•  ë•Œ sub-menu ì—´ê¸°
      document.querySelectorAll('.toggle-menu').forEach(menu => {
        menu.addEventListener('click', function() {
          const subMenu = this.nextElementSibling;
          if (subMenu && subMenu.classList.contains("sub-menu")) {
            if (subMenu.classList.contains('open')) {
              subMenu.classList.remove('open');
            } else {
              document.querySelectorAll('.sub-menu').forEach(menu => {
                menu.classList.remove('open');
              });
              subMenu.classList.add('open');
            }
          }
        });
      });

      //---------------------------------------------í™”ì‚´í‘œ í‘œì‹œ-----------------------------------------------
      document.addEventListener("DOMContentLoaded", function () {
    // ì „ì—­ ë³€ìˆ˜ ì •ì˜
    const canvasElements = [
        document.getElementById('chart-1'),
        document.getElementById('chart-2'),
        document.getElementById('chart-3'),
        document.getElementById('chart-4'),
        document.getElementById('chart-5'),
        document.getElementById('chart-6'),
    ];

    // ê° ìº”ë²„ìŠ¤ë³„ í˜„ì¬ ê°ë„ì™€ ëª©í‘œ ê°ë„ ê´€ë¦¬
    const angles = {
        'chart-1': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-2': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-3': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-4': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-5': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
        'chart-6': { current: Math.PI + (50 / 100) * Math.PI, target: Math.PI + (50 / 100) * Math.PI },
    };

    // ì• ë‹ˆë©”ì´ì…˜ ì§„í–‰ ìƒíƒœ ê´€ë¦¬
    const animationStates = {
        'chart-1': { animating: false },
        'chart-2': { animating: false },
        'chart-3': { animating: false },
        'chart-4': { animating: false },
        'chart-5': { animating: false },
        'chart-6': { animating: false },
    };

    // í˜„ì¬ ê°’ ê´€ë¦¬
    const currentValues = {
        'chart-1': null,
        'chart-2': null,
        'chart-3': null,
        'chart-4': null,
        'chart-5': null,
        'chart-6': null,
    };

    // ranges ë°°ì—´ ì •ì˜
    const ranges = [
        // ì‚°ì„±ë„ (waterPh, chart-1)
        {
            danger1Max: 7.68,      // ìœ„í—˜: 7.3 ~ 7.68
            warning1Min: 7.68, warning1Max: 8.06, // ê²½ê³ : 7.68 ~ 8.06
            normalMin: 8.06, normalMax: 8.44,     // ì •ìƒ: 8.06 ~ 8.44
            warning2Min: 8.44, warning2Max: 8.82, // ê²½ê³ : 8.44 ~ 8.82
            danger2Min: 8.82,     // ìœ„í—˜: 8.82 ~ 9.2
            min: 7.3, max: 9.2    // ì „ì²´ ë²”ìœ„
        },
        // ìš©ì¡´ì‚°ì†Œ (waterDo, chart-2)
        {
            danger1Max: 5.8016,      // ìœ„í—˜: 3.502 ~ 5.8016
            warning1Min: 5.8016, warning1Max: 8.1012, // ê²½ê³ : 5.8016 ~ 8.1012
            normalMin: 8.1012, normalMax: 10.4008,    // ì •ìƒ: 8.1012 ~ 10.4008
            warning2Min: 10.4008, warning2Max: 12.7004, // ê²½ê³ : 10.4008 ~ 12.7004
            danger2Min: 12.7004,     // ìœ„í—˜: 12.7004 ~ 15.0
            min: 3.502, max: 15.0    // ì „ì²´ ë²”ìœ„
        },
        // ìˆ˜ì˜¨ (waterTemp, chart-3)
        {
            danger1Max: 26.016,      // ìœ„í—˜: 24.77 ~ 26.016
            warning1Min: 26.016, warning1Max: 27.262, // ê²½ê³ : 26.016 ~ 27.262
            normalMin: 27.262, normalMax: 28.508,     // ì •ìƒ: 27.262 ~ 28.508
            warning2Min: 28.508, warning2Max: 29.754, // ê²½ê³ : 28.508 ~ 29.754
            danger2Min: 29.754,      // ìœ„í—˜: 29.754 ~ 31.0
            min: 24.77, max: 31.0    // ì „ì²´ ë²”ìœ„
        },
        // ì—¼ë„ (waterSalt, chart-4)
        {
            danger1Max: 21.0,      // ìœ„í—˜: 15.0 ~ 21.0
            warning1Min: 21.0, warning1Max: 27.0, // ê²½ê³ : 21.0 ~ 27.0
            normalMin: 27.0, normalMax: 33.0,     // ì •ìƒ: 27.0 ~ 33.0
            warning2Min: 33.0, warning2Max: 39.0, // ê²½ê³ : 33.0 ~ 39.0
            danger2Min: 39.0,      // ìœ„í—˜: 39.0 ~ 45.0
            min: 15.0, max: 45.0   // ì „ì²´ ë²”ìœ„
        },
        // ì•”ëª¨ë‹ˆì•„ (waterAmmonia, chart-5)
        {
            danger1Max: 0.042,      // ìœ„í—˜: 0.0 ~ 0.042
            warning1Min: 0.042, warning1Max: 0.084, // ê²½ê³ : 0.042 ~ 0.084
            normalMin: 0.084, normalMax: 0.126,     // ì •ìƒ: 0.084 ~ 0.126
            warning2Min: 0.126, warning2Max: 0.168, // ê²½ê³ : 0.126 ~ 0.168
            danger2Min: 0.168,      // ìœ„í—˜: 0.168 ~ 0.21
            min: 0.0, max: 0.21     // ì „ì²´ ë²”ìœ„
        },
        // ì•„ì§ˆì‚° (waterNitrogen, chart-6)
        {
            danger1Max: 1.2008,      // ìœ„í—˜: 0.001 ~ 1.2008
            warning1Min: 1.2008, warning1Max: 2.4006, // ê²½ê³ : 1.2008 ~ 2.4006
            normalMin: 2.4006, normalMax: 3.6004,     // ì •ìƒ: 2.4006 ~ 3.6004
            warning2Min: 3.6004, warning2Max: 4.8002, // ê²½ê³ : 3.6004 ~ 4.8002
            danger2Min: 4.8002,      // ìœ„í—˜: 4.8002 ~ 6.0
            min: 0.001, max: 6.0     // ì „ì²´ ë²”ìœ„
        }
    ];

    // ìº”ë²„ìŠ¤ IDì™€ ì¸ë±ìŠ¤ ë§¤í•‘
    const chartIndexMap = {
        'chart-1': 0, // waterPh
        'chart-2': 1, // waterDo
        'chart-3': 2, // waterTemp
        'chart-4': 3, // waterSalt
        'chart-5': 4, // waterAmmonia
        'chart-6': 5  // waterNitrogen
    };

    // ì´ì§• í•¨ìˆ˜ (easeOutQuad)
    function easeOutQuad(t) {
        return 1 - (1 - t) * (1 - t);
    }

    // ê²Œì´ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€)
    function updateGauge(chartId, value, min, max) {
        if (value === null || value === undefined || isNaN(value)) {
            console.warn(`updateGauge: ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ - chartId: ${chartId}, value: ${value}`);
            return;
        }

        // currentValues ê°±ì‹ 
        currentValues[chartId] = value;

        // ìº”ë²„ìŠ¤ IDì— ë”°ë¼ í•´ë‹¹ ranges ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
        const rangeIndex = chartIndexMap[chartId];
        const range = ranges[rangeIndex];

        // ì „ì²´ ìˆ«ì ë²”ìœ„
        const totalRange = range.max - range.min;

        // ê°’ì„ ë²”ìœ„ ë‚´ë¡œ í´ë¨í”„
        const clampedValue = Math.max(range.min, Math.min(value, range.max));

        // ê°’ì„ 0~1 ì‚¬ì´ë¡œ ì •ê·œí™”
        const normalizedValue = (clampedValue - range.min) / totalRange;

        // ê²Œì´ì§€ì˜ ì „ì²´ ê°ë„ (180ë„ = Math.PI)
        const totalAngle = Math.PI;
        const startAngle = Math.PI;

        // ëª©í‘œ ê°ë„ ê³„ì‚°
        const targetAngle = startAngle + normalizedValue * totalAngle;
        angles[chartId].target = targetAngle;

        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        if (!animationStates[chartId].animating) {
            animationStates[chartId].animating = true;
            animateGauge(chartId);
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
    function animateGauge(chartId) {
        const canvas = document.getElementById(chartId);
        const ctx = canvas.getContext("2d");
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        const startAngle = angles[chartId].current;
        const targetAngle = angles[chartId].target;
        const duration = 1000; // ì• ë‹ˆë©”ì´ì…˜ ì§€ì† ì‹œê°„ (1ì´ˆ)
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1); // 0ì—ì„œ 1ê¹Œì§€ ì§„í–‰
            const easedProgress = easeOutQuad(progress);

            // í˜„ì¬ ê°ë„ë¥¼ ëª©í‘œ ê°ë„ë¡œ ë³´ê°„
            angles[chartId].current = startAngle + (targetAngle - startAngle) * easedProgress;

            // ìº”ë²„ìŠ¤ ì§€ìš°ê¸°
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // ë°°ê²½ ê²Œì´ì§€ ê·¸ë¦¬ê¸°
            drawGaugeOnCanvas(chartId, canvas);

            // í™”ì‚´í‘œ ê·¸ë¦¬ê¸°
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight - 50;
            const len = 80;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(angles[chartId].current) * len, centerY + Math.sin(angles[chartId].current) * len);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 4;
            ctx.stroke();

            // ë°ì´í„° ê°’ ê·¸ë¦¬ê¸° (í™”ì‚´í‘œ ì‹œì‘ì ê³¼ ê²Œì´ì§€ ì‚¬ì´ì— ìœ„ì¹˜)
            const value = currentValues[chartId] ? currentValues[chartId].toFixed(3) : '-'; // ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ í‘œì‹œ
            ctx.fillStyle = '#fff'; // í…ìŠ¤íŠ¸ ìƒ‰ìƒ (í°ìƒ‰)
            ctx.font = 'bold 20px Arial'; // í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const radius = 100; // ê²Œì´ì§€ ë°˜ì§€ë¦„ (drawGaugeOnCanvasì—ì„œ ì •ì˜ë¨)
            const textY = centerY - radius / 3; // í™”ì‚´í‘œ ì‹œì‘ì ê³¼ ê²Œì´ì§€ ì‚¬ì´ì— ìœ„ì¹˜
            ctx.fillText(value, centerX, textY);

            // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ ê³„ì† ì§„í–‰
            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                animationStates[chartId].animating = false;
            }
        }

        requestAnimationFrame(step);
    }

    // ê²Œì´ì§€ ë°°ê²½ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function drawGaugeOnCanvas(canvasId, canvas) {
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const centerX = canvasWidth / 2;
        const centerY = canvasHeight - 50;
        const radius = 100;
        const gaugeWidth = 30;

        const colors = {
            danger1: ['#ff4500', '#ff7f7f'],  // ì²« ë²ˆì§¸ ìœ„í—˜
            warning1: ['#ffa500', '#ffd580'], // ì²« ë²ˆì§¸ ê²½ê³ 
            normal: ['#32cd32', '#90ee90'],   // ì •ìƒ
            warning2: ['#ffa500', '#ffd580'], // ë‘ ë²ˆì§¸ ê²½ê³ 
            danger2: ['#ff4500', '#ff7f7f']   // ë‘ ë²ˆì§¸ ìœ„í—˜
        };

        const labels = {
            danger1: 'ìœ„í—˜',
            warning1: 'ê²½ê³ ',
            normal: 'ì •ìƒ',
            warning2: 'ê²½ê³ ',
            danger2: 'ìœ„í—˜'
        };

        // ìº”ë²„ìŠ¤ IDì— ë”°ë¼ í•´ë‹¹ ranges ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
        const rangeIndex = chartIndexMap[canvasId];
        const range = ranges[rangeIndex];

        function drawGauge() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            const totalAngle = Math.PI;
            const startAngle = Math.PI;

            // ì „ì²´ ìˆ«ì ë²”ìœ„
            const totalRange = range.max - range.min;

            // ê° ì„¹ì…˜ì˜ ìˆ«ì ë²”ìœ„
            const danger1Range = range.danger1Max - range.min;
            const warning1Range = range.warning1Max - range.warning1Min;
            const normalRange = range.normalMax - range.normalMin;
            const warning2Range = range.warning2Max - range.warning2Min;
            const danger2Range = range.max - range.danger2Min;

            // ê° ì„¹ì…˜ì˜ ê°ë„ ê³„ì‚° (ìˆ«ì ë²”ìœ„ ë¹„ìœ¨ì— ë”°ë¼)
            const danger1Angle = (danger1Range / totalRange) * totalAngle;
            const warning1Angle = (warning1Range / totalRange) * totalAngle;
            const normalAngle = (normalRange / totalRange) * totalAngle;
            const warning2Angle = (warning2Range / totalRange) * totalAngle;
            const danger2Angle = (danger2Range / totalRange) * totalAngle;

            let currentAngle = startAngle;

            // ê·¸ë¦¼ì ì„¤ì •
            ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
            ctx.shadowBlur = 10;
            ctx.lineWidth = 2;

            // ê²Œì´ì§€ ê·¸ë¦¬ê¸° (ìœ„í—˜ â†’ ê²½ê³  â†’ ì •ìƒ â†’ ê²½ê³  â†’ ìœ„í—˜ ìˆœì„œ)
            drawSection(currentAngle, danger1Angle, colors.danger1);  // ì²« ë²ˆì§¸ ìœ„í—˜
            currentAngle += danger1Angle;
            drawSection(currentAngle, warning1Angle, colors.warning1); // ì²« ë²ˆì§¸ ê²½ê³ 
            currentAngle += warning1Angle;
            drawSection(currentAngle, normalAngle, colors.normal);    // ì •ìƒ
            currentAngle += normalAngle;
            drawSection(currentAngle, warning2Angle, colors.warning2); // ë‘ ë²ˆì§¸ ê²½ê³ 
            currentAngle += warning2Angle;
            drawSection(currentAngle, danger2Angle, colors.danger2);  // ë‘ ë²ˆì§¸ ìœ„í—˜

            ctx.shadowBlur = 0; // ê·¸ë¦¼ì í•´ì œ

            drawLabels(startAngle, danger1Angle, warning1Angle, normalAngle, warning2Angle, danger2Angle);
        }

        function drawSection(start, angle, colorPair) {
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, start, start + angle);
            ctx.arc(centerX, centerY, radius - gaugeWidth, start + angle, start, true);
            ctx.closePath();
            ctx.fillStyle = colorPair[0]; // ì²« ë²ˆì§¸ ìƒ‰ìƒë§Œ ì‚¬ìš© (ê·¸ë¼ë””ì–¸íŠ¸ ì œê±°)
            ctx.fill();
            ctx.strokeStyle = '#333'; // í…Œë‘ë¦¬
            ctx.stroke();
        }

        function drawLabels(startAngle, danger1Angle, warning1Angle, normalAngle, warning2Angle, danger2Angle) {
            const labelRadius = radius - gaugeWidth / 2;
            ctx.fillStyle = '#000';
            ctx.font = 'bold 15px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const angles = [
                startAngle + danger1Angle / 2,                    // ì²« ë²ˆì§¸ ìœ„í—˜ ë¼ë²¨
                startAngle + danger1Angle + warning1Angle / 2,    // ì²« ë²ˆì§¸ ê²½ê³  ë¼ë²¨
                startAngle + danger1Angle + warning1Angle + normalAngle / 2, // ì •ìƒ ë¼ë²¨
                startAngle + danger1Angle + warning1Angle + normalAngle + warning2Angle / 2, // ë‘ ë²ˆì§¸ ê²½ê³  ë¼ë²¨
                startAngle + danger1Angle + warning1Angle + normalAngle + warning2Angle + danger2Angle / 2 // ë‘ ë²ˆì§¸ ìœ„í—˜ ë¼ë²¨
            ];
            const texts = [labels.danger1, labels.warning1, labels.normal, labels.warning2, labels.danger2];

            angles.forEach((angle, i) => {
                const x = centerX + Math.cos(angle) * labelRadius;
                const y = centerY + Math.sin(angle) * labelRadius;
                ctx.fillText(texts[i], x, y);
            });
        }

        drawGauge();
    }
        // ì´ˆê¸° ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
        canvasElements.forEach(canvas => {
          drawGaugeOnCanvas(canvas.id, canvas);
        });

        // ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function fetchLatestTankData() {
          const urlParams = new URLSearchParams(window.location.search);
          const tankIdx = urlParams.get("tankIdx");

          if (tankIdx) {
            fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
              .then(response => {
                if (!response.ok) {
                  throw new Error(`âŒ HTTP ì˜¤ë¥˜: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                console.log("âœ… ìµœì‹  ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì™„ë£Œ:", data);

                // currentValues ì—…ë°ì´íŠ¸
                currentValues['chart-1'] = parseFloat(data.waterPh);
                currentValues['chart-2'] = parseFloat(data.waterDo);
                currentValues['chart-3'] = parseFloat(data.waterTemp);
                currentValues['chart-4'] = parseFloat(data.waterSalt);
                currentValues['chart-5'] = parseFloat(data.waterAmmonia);
                currentValues['chart-6'] = parseFloat(data.waterNitrogen);

                // í™”ì‚´í‘œ ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
                updateGauge('chart-1', currentValues['chart-1'], dataRanges['chart-1'].min, dataRanges['chart-1'].max);
                updateGauge('chart-2', currentValues['chart-2'], dataRanges['chart-2'].min, dataRanges['chart-2'].max);
                updateGauge('chart-3', currentValues['chart-3'], dataRanges['chart-3'].min, dataRanges['chart-3'].max);
                updateGauge('chart-4', currentValues['chart-4'], dataRanges['chart-4'].min, dataRanges['chart-4'].max);
                updateGauge('chart-5', currentValues['chart-5'], dataRanges['chart-5'].min, dataRanges['chart-5'].max);
                updateGauge('chart-6', currentValues['chart-6'], dataRanges['chart-6'].min, dataRanges['chart-6'].max);
              })
              .catch(error => {
                console.error("âŒ ìˆ˜ì¡° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
              });
          } else {
            console.warn("tankIdxê°€ URLì— ì—†ìŠµë‹ˆë‹¤.");
          }
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘
        fetchLatestTankData();

        // 24ì‹œê°„ë§ˆë‹¤ ìë™ ê°±ì‹ 
        setInterval(fetchLatestTankData, 1000*60*60*24);
      });

      //---------------------[ìµœì‹  ìˆ˜ì§ˆ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ìë™ ìƒˆë¡œê³ ì¹¨ ë°±ì—”ë“œ ìŠ¤í¬ë¦½íŠ¸]------------------------
      function startAutoRefresh() {
        fetchLatestTankData();
        setInterval(fetchLatestTankData, 1000*60*60*24);
      }

      // í˜ì´ì§€ê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ ìë™ ê°±ì‹  ì‹œì‘
      document.addEventListener("DOMContentLoaded", startAutoRefresh);

      // í´ë¦­ ì´ë²¤íŠ¸ ë° ì‹¤ì‹œê°„ ë°ì´í„°
      const cardElements = document.querySelectorAll('.card');
      let labelsMap = {};
      let valuesMap = {};

      cardElements.forEach(card => {
        const canvas = card.querySelector('canvas');
        const chartId = canvas.id;
        labelsMap[chartId] = [];
        valuesMap[chartId] = [];

        card.addEventListener('click', () => {
          cardElements.forEach(c => {
            c.classList.remove('clicked', 'animate-click');
          });

          card.classList.add('clicked', 'animate-click');
          setTimeout(() => {
            card.classList.remove('animate-click');
          }, 300);

          const label = dataRanges[chartId].label;
          showGraphFor(chartId, label);
        });
      });

      // ì´ˆê¸° ë¹ˆ ê·¸ë˜í”„ ì„¤ì •
      window.onload = function() {
        const ctx = document.getElementById('aihubGraph').getContext('2d');
        realtimeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [{
              label: 'ë°ì´í„° ì—†ìŒ',
              data: [],
              borderColor: '#4A90E2',
              backgroundColor: 'rgba(74, 144, 226, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'ì‹¤ì‹œê°„ ë°ì´í„°',
                  color: '#ffffff',
                  font: { size: 14 }
                },
                ticks: { display: true, color: '#ffffff', font: { size: 12 } }
              },
              y: {
                title: { display: false },
                ticks: { color: '#ffffff', font: { size: 12 }, padding: 10 }
              }
            },
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                color: '#ffffff',
                font: { size: 16 },
                padding: { top: 10, bottom: 20 }
              }
            }
          }
        });
      };

      // ê·¸ë˜í”„ ì¶œë ¥ í•¨ìˆ˜
      function showGraphFor(chartId, label) {
        const ctx = document.getElementById('aihubGraph').getContext('2d');
        const valueKeyMap = {
          'chart-1': 'waterPh',
          'chart-2': 'waterDo',
          'chart-3': 'waterTemp',
          'chart-4': 'waterSalt',
          'chart-5': 'waterAmmonia',
          'chart-6': 'waterNitrogen'
        };
        const dataKey = valueKeyMap[chartId];

        if (realtimeChart) {
          realtimeChart.destroy();
        }

        realtimeChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labelsMap[chartId],
            datasets: [{
              label: `${label} ì‹¤ì‹œê°„ ë°ì´í„°`,
              data: valuesMap[chartId],
              borderColor: '#4A90E2',
              backgroundColor: 'rgba(74, 144, 226, 0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'ì‹¤ì‹œê°„ ë°ì´í„°',
                  color: '#ffffff',
                  font: { size: 14 }
                },
                ticks: { display: true, color: '#ffffff', font: { size: 12 } }
              },
              y: {
                title: { display: false },
                ticks: { color: '#ffffff', font: { size: 12 } }
              }
            },
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: label,
                color: '#ffffff',
                font: { size: 16 },
                padding: { top: 10, bottom: 20 }
              }
            }
          }
        });

        // ì¦‰ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        fetchLatestTankDataForGraph(chartId, dataKey, labelsMap[chartId], valuesMap[chartId], realtimeChart);

        // ê¸°ì¡´ setInterval ì œê±° (ì¤‘ë³µ ë°©ì§€)
        if (window.graphInterval) {
          clearInterval(window.graphInterval);
        }

        // 24ì‹œê°„ë§ˆë‹¤ ê°±ì‹ 
        window.graphInterval = setInterval(() => {
          fetchLatestTankDataForGraph(chartId, dataKey, labelsMap[chartId], valuesMap[chartId], realtimeChart);
        }, 1000*60*60*24);
      }

      // ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ ê·¸ë˜í”„ ê°±ì‹ 
      function fetchLatestTankDataForGraph(chartId, dataKey, labels, values, chart) {
        const urlParams = new URLSearchParams(window.location.search);
        const tankIdx = urlParams.get("tankIdx");

        if (tankIdx) {
          fetch(`/tank/data/latest?tankIdx=${tankIdx}`)
            .then(response => response.json())
            .then(data => {
              const value = parseFloat(data[dataKey]);
              const now = new Date();
              const timeLabel = now.toLocaleTimeString();

              if (!isNaN(value)) {
                labels.push(timeLabel);
                values.push(value);

                if (labels.length > 10) {
                  labels.shift();
                  values.shift();
                }

                chart.data.labels = labels;
                chart.data.datasets[0].data = values;
                chart.update();
              }
            })
            .catch(err => console.error("âŒ ê·¸ë˜í”„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", err));
        }
      }
    </script>
  </body>
</html>