<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">   
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ìƒˆìš°ì–‘ì‹ ê´€ì œì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ" />
    <link rel="stylesheet" href="/css/maindashboard.css" />
    <title>ê´€ì œì„¼í„° ëŒ€ì‹œë³´ë“œ</title>
  </head>
  <body>
    <div class="wrapper">
    
<!-- í–„ë²„ê±° ë²„íŠ¼ -->
    <button class="hamburger-btn" id="hamburgerBtn">â˜°</button>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ë©”ë‰´</h2>
      </div>
      <ul class="sidebar-menu">
        <!-- í™ˆ -->
        <li>
          <a href="/maindashboard" class="toggle-menu">í™ˆ</a>
        </li>
        <!-- ìˆ˜ì¡° ì •ë³´ ë“±ë¡ -->
        <li>
          <a href="/tank" class="toggle-menu">ìˆ˜ì¡° ì •ë³´ ë“±ë¡</a>
        </li>
        <!-- ì•ŒëŒ íˆìŠ¤í† ë¦¬ -->
        <li>
          <a href="/alarmHistory2" class="toggle-menu">ì•ŒëŒ íˆìŠ¤í† ë¦¬</a>
        </li>
        <!-- íšŒì› ì •ë³´ ê´€ë¦¬ -->
        <li>
          <a href="javascript:void(0)" class="toggle-menu">íšŒì› ì •ë³´ ê´€ë¦¬</a>
          <ul class="sub-menu">
            <li><a th:href="@{/edit/{id}(id=${session.loginUser.userId})}">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
            <li><a href="/delete">íšŒì› íƒˆí‡´</a></li>
          </ul>
        </li>
      </ul>
    </div>

      <!-- ë©”ì¸ ì½˜í…ì¸  -->
      <main class="main-content">
        <header class="header">
          <h1 class="page-title">ì–‘ì‹ê´€ì œì‹œìŠ¤í…œ</h1>
          
          
          <div class="user-info">

	          
          <div th:if="${session.loginUser != null}">
		    <p th:text="${session.loginUser.userId}"></p> <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì•„ì´ë”” ì¶œë ¥ -->
		</div>

          <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button> <!-- âœ… ìˆ˜ì •ëœ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
          
          <div th:if="${session.loginUser == null}">
		    <p>ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
		</div>
          </div>
        </header>

        <!-- ìˆ˜ì¡° ê´€ë¦¬ ì‹œìŠ¤í…œ -->
        <section class="control-center">
          <div class="control-item"></div>
        </section>
      </main>

    <script>
  //ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ì‹œ ìë™ ë¡œê·¸ì¸ ê´€ë ¨ ë°ì´í„° ì™„ì „ ì‚­ì œ
    //ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ì‹œ ìë™ ë¡œê·¸ì¸ ê´€ë ¨ ë°ì´í„° ì™„ì „ ì‚­ì œ
function handleLogout() {
    console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");

    const authToken = localStorage.getItem("authToken");

    fetch("/api/member/logout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: authToken }),
    })
    .then(response => {
        if (response.ok) {
            console.log("âœ… ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");

            localStorage.removeItem("authToken");
            localStorage.removeItem("autoLogin");
            localStorage.removeItem("savedUserId");
            localStorage.removeItem("savedPassword");
            sessionStorage.clear();

            document.cookie = "JSESSIONID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            console.log("âœ… ëª¨ë“  ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ");

            setTimeout(() => {
                alert("âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
                window.location.href = "/login";
            }, 1000);
        } else {
            console.warn("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ì‘ë‹µ ì˜¤ë¥˜");
        }
    })
    .catch(error => console.error("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
}

/**
 * ğŸ”¹ ì¿ í‚¤ ì‚­ì œ í•¨ìˆ˜
 */
function deleteCookie(name) {
    document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict;Secure`;
}

// í–„ë²„ê±° ë²„íŠ¼ìœ¼ë¡œ ì‚¬ì´ë“œë°” í† ê¸€
hamburgerBtn.addEventListener("click", () => {
  sidebar.classList.toggle("active");
});

// ì„œë¸Œ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
const toggleMenus = document.querySelectorAll(".toggle-menu");
toggleMenus.forEach(menu => {
  menu.addEventListener("click", (e) => {
    const subMenu = menu.nextElementSibling;
    if (subMenu && subMenu.classList.contains("sub-menu")) {
      e.preventDefault();
      subMenu.style.display = subMenu.style.display === "block" ? "none" : "block";
    }
  });
});

// ì•Œë¦¼ ë¡œê·¸
function toggleNotifications() {
    var log = document.getElementById("notificationLog");
    log.style.display = log.style.display === "block" ? "none" : "block";
}

/**
 * ğŸ”¹ ì €ì¥ëœ ìˆ˜ì¡° ë°ì´í„°ë¥¼ APIì—ì„œ ë¶ˆëŸ¬ì™€ í™”ë©´ì— ì¶”ê°€ (ìµœì‹  ë°ì´í„° ë¨¼ì € ê°€ì ¸ì˜´)
 */
async function loadTanks(userId) {
    console.log("ğŸš€ ì„œë²„ë¡œ ìˆ˜ì¡° ë¦¬ìŠ¤íŠ¸ ìš”ì²­ ì¤‘... userId:", userId);

    try {
        let response = await fetch(`/tank/list?userId=${userId}`);

        if (!response.ok) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }

        let tanks = await response.json();
        console.log("âœ… ìˆ˜ì¡° ë°ì´í„° ì‘ë‹µ:", tanks);

        let tankContainer = document.querySelector('.control-center');
        tankContainer.innerHTML = "";

        for (let tank of tanks) {
            if (tank.tank_delete === "N") { 
                let latestData = await fetchLatestTankData(tank.tankIdx);

                let tankDiv = document.createElement('div');
                tankDiv.classList.add('control-item');
                tankDiv.setAttribute("id", `tank-${tank.tankIdx}`);

                tankDiv.innerHTML = `
                    <h4>ìˆ˜ì¡°ê´€ë¦¬ì‹œìŠ¤í…œ (${tank.tankIdx}ë²ˆ ìˆ˜ì¡°)
                        <button class="edit-btn" onclick="editTank(${tank.tankIdx})">ìˆ˜ì •</button>
                        <button class="delete-btn" onclick="deleteTank(${tank.tankIdx})">ì‚­ì œ</button>
                    </h4>
                    <div class="tank-info" onclick="goToDashboardDetail(${tank.tankIdx})">
                        <div class="tank-data">
                            <p class="waterPh">ì‚°ì„±ë„: ${latestData?.waterPh ?? "ì •ë³´ ì—†ìŒ"}</p>
                            <p class="waterDo">ìš©ì¡´ì‚°ì†Œ: ${latestData?.waterDo ?? "ì •ë³´ ì—†ìŒ"}</p>
                            <p class="waterTemp">ìˆ˜ì˜¨: ${latestData?.waterTemp ?? "ì •ë³´ ì—†ìŒ"}</p>
                            <p class="waterSalt">ì—¼ë„: ${latestData?.waterSalt ?? "ì •ë³´ ì—†ìŒ"}</p>
                            <p class="waterAmmonia">ì•”ëª¨ë‹ˆì•„: ${latestData?.waterAmmonia ?? "ì •ë³´ ì—†ìŒ"}</p>
                            <p class="waterNitrogen">ì•„ì§ˆì‚°: ${latestData?.waterNitrogen ?? "ì •ë³´ ì—†ìŒ"}</p>
                        </div>
                    </div>
                    <div class="alarm-log-container" id="alarm-log-${tank.tankIdx}">
                    	<h5>ìˆ˜ì¡° ì•ŒëŒ</h5>
                    	<div class="alarm-content" id="alarm-content-${tank.tankIdx}"></div>
                	</div>
                `;

                tankContainer.appendChild(tankDiv);
            }
        }
    } catch (error) {
        console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("âŒ ìˆ˜ì¡° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤!");
    }
}

window.onload = function () {
    let userId = `[[${session.loginUser?.userId}]]`;
    loadTanks(userId);
};

/**
 * ğŸ”¹ íŠ¹ì • tankIdxì˜ ìµœì‹  ìˆ˜ì§ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
 */
async function fetchLatestTankData(tankIdx) {
    try {
        let response = await fetch(`/tank/data/latest?tankIdx=${tankIdx}`);
        if (!response.ok) {
            throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        let data = await response.json();
        return data;
    } catch (error) {
        console.error(`âŒ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (tankIdx=${tankIdx}):`, error);
        return null;
    }
}

/**
 * ğŸ”¹ ìˆ˜ì¡° ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
 */
function editTank(tankIdx) {
    console.log(`ğŸš€ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™: tankIdx=${tankIdx}`);
    window.location.href = `/tank/edit/${tankIdx}`;
}

/**
 * ğŸ”¹ ìˆ˜ì¡° ì‚­ì œ í•¨ìˆ˜
 */
async function deleteTank(tankIdx) {
    console.log(`ğŸš€ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨: tankIdx=${tankIdx}`);

    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        let response = await fetch(`/tank/delete/${tankIdx}`, { method: "PUT" });

        if (!response.ok) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }

        alert("âœ… ìˆ˜ì¡° ì‚­ì œ ì™„ë£Œ!");
        document.getElementById(`tank-${tankIdx}`).remove();
    } catch (error) {
        console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        alert("âŒ ì‚­ì œ ì‹¤íŒ¨!");
    }
}

/**
 * ğŸ”¹ ìˆ˜ì¡° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
 */
function goToDashboardDetail(tankIdx) {
    console.log(`ğŸš€ ìˆ˜ì¡° ìƒì„¸ í˜ì´ì§€ ì´ë™: tankIdx=${tankIdx}`);
    window.location.href = `/dashboarddetail?tankIdx=${tankIdx}`;
}

/**
 * ğŸ”¹ ëª¨ë“  ìˆ˜ì¡°ì— ëŒ€í•´ ìë™ ê°±ì‹  ì‹œì‘ (5ì´ˆë§ˆë‹¤ ì‹¤í–‰)
 */
function startAutoUpdateForTanks(tankIds) {
    console.log("â³ ëª¨ë“  ìˆ˜ì¡°ì— ëŒ€í•œ ìë™ ê°±ì‹  ì‹œì‘:", tankIds);

    tankIds.forEach(tankIdx => {
        fetchLatestTankData(tankIdx);
        setInterval(() => fetchLatestTankData(tankIdx), 1000*60*60*24); // ì¶”í›„ ì‹œê°„ ë³€ê²½í•˜ê¸° í˜„ì¬ í•˜ë£¨ë¡œ ì„¤ì •
    });
}

/**
 * ğŸ”¹ í˜ì´ì§€ ë¡œë“œ ì‹œ ìˆ˜ì¡° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¨ í›„, ìë™ ê°±ì‹  ì‹œì‘
 */
document.addEventListener("DOMContentLoaded", function () {
    let userId = `[[${session.loginUser?.userId}]]`;

    fetch(`/tank/list?userId=${userId}`)
        .then(response => response.json())
        .then(tanks => {
            let tankIds = tanks.filter(tank => tank.tank_delete === "N").map(tank => tank.tankIdx);
            startAutoUpdateForTanks(tankIds);
        })
        .catch(error => console.error("âŒ ìˆ˜ì¡° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
});


/* ì•ŒëŒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì—…ë°ì´íŠ¸ */

async function updateAlarmContent(tankIdx) {
    try {
        // ì‹¤ì œ API í˜¸ì¶œ
        // let response = await fetch(`/tank/alarm?tankIdx=${tankIdx}`);
        // if (!response.ok) throw new Error(`âŒ ì•ŒëŒ ë°ì´í„° ìš”ì²­ ì˜¤ë¥˜: ${response.status}`);
        // let alarms = await response.json();

        // í…ŒìŠ¤íŠ¸ ë°ì´í„°
        // ì•„ë˜ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³ , ìœ„ì˜ ì‹¤ì œ ë°ì´í„° ë¡œì§ì„ ì‚¬ìš©
        let alarms = [
            { "timestamp": "2025-03-18T15:03:00", "message": "ìš©ì¡´ì‚°ì†Œ 4mg/L", "status": "critical" },
            { "timestamp": "2025-03-18T14:55:00", "message": "ì•”ëª¨ë‹ˆì•„ 0.5ppm", "status": "critical" },
            { "timestamp": "2025-03-18T14:50:00", "message": "ìˆ˜ì˜¨ ì´ìƒ", "status": "warning" }
        ];
        console.log(`âœ… í…ŒìŠ¤íŠ¸ ì•ŒëŒ ë°ì´í„° (tankIdx=${tankIdx}):`, alarms);
        // í…ŒìŠ¤íŠ¸ ë°ì´í„° ë
        
        let alarmContent = document.getElementById(`alarm-content-${tankIdx}`);
        let criticalCount = 0, warningCount = 0;
        let latestAlarms = [];

        alarms.forEach(alarm => {
            if (alarm.status === "critical") criticalCount++;
            else if (alarm.status === "warning") warningCount++;
            if (latestAlarms.length < 2) latestAlarms.push(alarm); // ìµœì‹  2ê±´ë§Œ í‘œì‹œ
        });

        const totalActive = criticalCount + warningCount;
        alarmContent.innerHTML = `
            <strong>í˜„ì¬ í™œì„± ì•ŒëŒ: ${totalActive}ê±´</strong><br>
            ğŸš¨ ìœ„í—˜: ${criticalCount}ê±´  |  âš ï¸ ê²½ê³ : ${warningCount}ê±´<br>
            ${latestAlarms.map(alarm => `
              ğŸ•’ ${new Date(alarm.timestamp).toLocaleTimeString()} - ìˆ˜ì¡° ${tankIdx}: ${alarm.message} (${alarm.status === "critical" ? "ìœ„í—˜" : "ê²½ê³ "})
            `).join("<br>")}
        `;
        
        alarmContent.style.cursor = "pointer"; // í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” íŒíŠ¸
        alarmContent.addEventListener("click", () => {
            window.location.href = "/alarmHistory";
        });        
    } catch (error) {
        console.error(`âŒ ì•ŒëŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (tankIdx=${tankIdx}):`, error);
        let alarmContent = document.getElementById(`alarm-content-${tankIdx}`);
        alarmContent.innerHTML = "ì•ŒëŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    }
}

/* ì£¼ê¸°ì  ì•ŒëŒ ì—…ë°ì´íŠ¸ (5ì´ˆë§ˆë‹¤) */
function startAlarmUpdates(tankIds) {
    tankIds.forEach(tankIdx => {
        updateAlarmContent(tankIdx); // ì´ˆê¸° í˜¸ì¶œ
        setInterval(() => updateAlarmContent(tankIdx), 5000); // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì•ŒëŒ ì—…ë°ì´íŠ¸ ì‹œì‘
document.addEventListener("DOMContentLoaded", function () {
    let userId = `[[${session.loginUser?.userId}]]`;
    fetch(`/tank/list?userId=${userId}`)
        .then(response => response.json())
        .then(tanks => {
            let tankIds = tanks.filter(tank => tank.tank_delete === "N").map(tank => tank.tankIdx);
            startAlarmUpdates(tankIds);
        })
        .catch(error => console.error("âŒ ì•ŒëŒ ì—…ë°ì´íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:", error));
});
    </script>

  </body>
</html>
