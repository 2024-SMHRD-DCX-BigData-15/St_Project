<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">   
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="ìƒˆìš°ì–‘ì‹ ê´€ì œì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ" />
    <link rel="stylesheet" href="/css/maindashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>ê´€ì œì„¼í„° ëŒ€ì‹œë³´ë“œ</title>
  </head>
  <body>
    <div class="wrapper">
      <!-- í–„ë²„ê±° ë²„íŠ¼ -->
      <button class="hamburger-btn" id="hamburgerBtn">â˜°</button>

      <!-- ì‚¬ì´ë“œë°” -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>ë©”ë‰´</h2>
        </div>
        <ul class="sidebar-menu">
          <li><a href="/maindashboard" class="toggle-menu">í™ˆ</a></li>
          <li><a href="/tank" class="toggle-menu">ìˆ˜ì¡° ì •ë³´ ë“±ë¡</a></li>
          <li><a href="/alarmHistory2" class="toggle-menu">ì•ŒëŒ íˆìŠ¤í† ë¦¬</a></li>
          <li>
            <a href="javascript:void(0)" class="toggle-menu">íšŒì› ì •ë³´ ê´€ë¦¬</a>
            <ul class="sub-menu">
              <li><a th:href="@{/edit/{id}(id=${session.loginUser.userId})}">íšŒì› ì •ë³´ ìˆ˜ì •</a></li>
              <li><a href="/delete">íšŒì› íƒˆí‡´</a></li>
            </ul>
          </li>
        </ul>
      </div>

      <!-- ë©”ì¸ ì½˜í…ì¸  -->
      <main class="main-content">
        <header class="header">
          <h1 class="page-title">ì–‘ì‹ê´€ì œì‹œìŠ¤í…œ</h1>
          <div class="user-info">
            <div th:if="${session.loginUser != null}">
              <p th:text="${session.loginUser.userId}"></p>
            </div>
            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            <div th:if="${session.loginUser == null}">
              <p>ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
            </div>
          </div>
        </header>

        <!-- ìˆ˜ì¡° ê´€ë¦¬ ì‹œìŠ¤í…œ -->
        <section class="control-center">
          <div class="control-item"></div>
        </section>
      </main>
    </div>

    <script>
      // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
      function handleLogout() {
        console.log("ğŸš€ ë¡œê·¸ì•„ì›ƒ ìš”ì²­");
        const authToken = localStorage.getItem("authToken");
        fetch("/api/member/logout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token: authToken }),
        })
        .then(response => {
          if (response.ok) {
            console.log("âœ… ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
            localStorage.removeItem("authToken");
            localStorage.removeItem("autoLogin");
            localStorage.removeItem("savedUserId");
            localStorage.removeItem("savedPassword");
            sessionStorage.clear();
            document.cookie = "JSESSIONID=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            console.log("âœ… ëª¨ë“  ì €ì¥ì†Œ ë°ì´í„° ì‚­ì œ ì™„ë£Œ");
            setTimeout(() => {
              alert("âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ!");
              window.location.href = "/login";
            }, 1000);
          } else {
            console.warn("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ì‘ë‹µ ì˜¤ë¥˜");
          }
        })
        .catch(error => console.error("ğŸš¨ ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }

      // ì¿ í‚¤ ì‚­ì œ í•¨ìˆ˜
      function deleteCookie(name) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;SameSite=Strict;Secure`;
      }

      // í–„ë²„ê±° ë²„íŠ¼ìœ¼ë¡œ ì‚¬ì´ë“œë°” í† ê¸€
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const sidebar = document.getElementById("sidebar");
      hamburgerBtn.addEventListener("click", () => {
        sidebar.classList.toggle("active");
      });

      // ì„œë¸Œ ë©”ë‰´ í† ê¸€ ê¸°ëŠ¥
      const toggleMenus = document.querySelectorAll(".toggle-menu");
      toggleMenus.forEach(menu => {
        menu.addEventListener("click", (e) => {
          const subMenu = menu.nextElementSibling;
          if (subMenu && subMenu.classList.contains("sub-menu")) {
            e.preventDefault();
            subMenu.style.display = subMenu.style.display === "block" ? "none" : "block";
          }
        });
      });

      // ìˆ˜ì¡° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ í™”ë©´ì— ì¶”ê°€ (ìµœì´ˆ ë¡œë“œ)
      async function loadTanks(userId) {
        console.log("ğŸš€ ì„œë²„ë¡œ ìˆ˜ì¡° ë¦¬ìŠ¤íŠ¸ ìš”ì²­ ì¤‘... userId:", userId);
        try {
          let response = await fetch(`/tank/list?userId=${userId}`);
          if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
          let tanks = await response.json();
          console.log("âœ… ìˆ˜ì¡° ë°ì´í„° ì‘ë‹µ:", tanks);

          tanks.sort((a, b) => a.tankIdx - b.tankIdx);
          console.log("ğŸ“Œ ì •ë ¬ëœ ìˆ˜ì¡° ë°ì´í„°:", tanks);

          let tankContainer = document.querySelector('.control-center');
          tankContainer.innerHTML = ""; // ìµœì´ˆ ë¡œë“œ ì‹œë§Œ ë¹„ì›€

          let displayNumber = 1;
          for (let tank of tanks) {
            if (tank.tank_delete === "N") {
              let tankDiv = document.createElement('div');
              tankDiv.classList.add('control-item');
              tankDiv.setAttribute("id", `tank-${tank.tankIdx}`);
              tankDiv.innerHTML = `
                <h4>ìˆ˜ì¡°ê´€ë¦¬ì‹œìŠ¤í…œ (${displayNumber}ë²ˆ ìˆ˜ì¡°)
                  <div class="button-group">
                    <button class="edit-btn" onclick="editTank(${tank.tankIdx})">
                      <img src="/image/1.png" width="20" height="20">
                    </button>
                    <button class="delete-btn" onclick="deleteTank(${tank.tankIdx})">
                      <img src="/image/2.png" width="20" height="20">
                    </button>
                  </div>
                </h4>
                <div class="tank-info" onclick="goToDashboardDetail(${tank.tankIdx})">
                  <canvas id="tankChart-${tank.tankIdx}" width="300" height="200"></canvas>
                  <div class="tank-data">
                    <p><span id="ph-${tank.tankIdx}"></span></p>
                    <p><span id="do-${tank.tankIdx}"></span></p>
                    <p><span id="temp-${tank.tankIdx}"></span></p>
                    <p><span id="salt-${tank.tankIdx}"></span></p>
                    <p><span id="ammonia-${tank.tankIdx}"></span></p>
                    <p><span id="nitrogen-${tank.tankIdx}"></span></p>
                  </div>
                </div>
                <div class="alarm-log-container" id="alarm-log-${tank.tankIdx}">
                  <h5>ìˆ˜ì¡° ì•ŒëŒ ë¡œê·¸</h5>
                  <div class="alarm-content" id="alarm-content-${tank.tankIdx}"></div>
                </div>
              `;
              tankContainer.appendChild(tankDiv);
              await updateTankData(tank.tankIdx); // ìµœì´ˆ ë°ì´í„° ì—…ë°ì´íŠ¸
              displayNumber++;
            }
          }
          return tanks.filter(tank => tank.tank_delete === "N").map(tank => tank.tankIdx);
        } catch (error) {
          console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
          return [];
        }
      }

      // ê°œë³„ ìˆ˜ì¡° ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      async function updateTankData(tankIdx) {
        let latestData = await fetchLatestTankData(tankIdx);
        if (latestData) {
          document.getElementById(`ph-${tankIdx}`).textContent = latestData.waterPh;
          document.getElementById(`do-${tankIdx}`).textContent = latestData.waterDo;
          document.getElementById(`temp-${tankIdx}`).textContent = latestData.waterTemp;
          document.getElementById(`salt-${tankIdx}`).textContent = latestData.waterSalt;
          document.getElementById(`ammonia-${tankIdx}`).textContent = latestData.waterAmmonia;
          document.getElementById(`nitrogen-${tankIdx}`).textContent = latestData.waterNitrogen;
          await renderTankChart({ tankIdx }); // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        }
      }

      // ìµœì‹  ìˆ˜ì§ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      async function fetchLatestTankData(tankIdx) {
        try {
          let response = await fetch(`/tank/data/latest?tankIdx=${tankIdx}`);
          if (!response.ok) throw new Error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error(`âŒ ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (tankIdx=${tankIdx}):`, error);
          return null;
        }
      }

      // ì •ê·œí™” í•¨ìˆ˜
      function normalize(value, min, max) {
        if (max === min) return 0;
        return (value - min) / (max - min);
      }

      // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥ ê°ì²´
      const chartInstances = {};

      // ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜
   async function renderTankChart(tank) {
  const canvasId = `tankChart-${tank.tankIdx}`;
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const tankInfo = canvas.closest('.tank-info'); // tank-info ìš”ì†Œ ì°¾ê¸°

  // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
  console.log(`Rendering chart for tankIdx: ${tank.tankIdx}`);

  // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
  if (chartInstances[canvasId]) {
    chartInstances[canvasId].destroy();
  }

  // ìµœì‹  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  let latestData = await fetchLatestTankData(tank.tankIdx);
  if (!latestData) {
    console.error(`Tank ${tank.tankIdx} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨`);
    return;
  }

  // ìˆ˜ì§ˆ ë°ì´í„° ë°°ì—´
  const dataValues = [
    latestData.waterPh,        // ì‚°ì„±ë„
    latestData.waterDo,        // ìš©ì¡´ì‚°ì†Œ
    latestData.waterTemp,      // ìˆ˜ì˜¨
    latestData.waterSalt,      // ì—¼ë„
    latestData.waterAmmonia,   // ì•”ëª¨ë‹ˆì•„
    latestData.waterNitrogen   // ì•„ì§ˆì‚°
  ];

  // ê° ìˆ˜ì§ˆ í•­ëª©ì˜ ë²”ìœ„ ì •ì˜ (ê²½ê³  â†’ ì •ìƒ â†’ ê²½ê³ )
  const ranges = [
    // ì‚°ì„±ë„ (pH)
    {
      warning1Min: 7.3,   warning1Max: 7.4,   // ê²½ê³ : 7.3 ~ 7.4 (ë‚®ìŒ)
      normalMin: 7.5,     normalMax: 9.0,     // ì •ìƒ: 7.5 ~ 9.0
      warning2Min: 9.1,   warning2Max: 9.2,   // ê²½ê³ : 9.1 ~ 9.2 (ë†’ìŒ)
      min: 7.3, max: 9.2   // ì •ê·œí™” ë²”ìœ„
    },
    // ìš©ì¡´ì‚°ì†Œ (mg/L)
    {
      warning1Min: 3.502,  warning1Max: 4.9,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ (ì œê±°)
      normalMin: 5.0,     normalMax: 10.0,    // ì •ìƒ: 5.0 ~ 10.0
      warning2Min: 10.1,  warning2Max: 15.0,  // ê²½ê³ : 10.1 ~ 15.0 (ë†’ìŒ)
      min: 3.502, max: 15.0  // ì •ê·œí™” ë²”ìœ„
    },
    // ìˆ˜ì˜¨ (Â°C)
    {
      warning1Min: 24.77, warning1Max: 26.0,  // ê²½ê³ : 24.77 ~ 26.0 (ë‚®ìŒ)
      normalMin: 26.0,    normalMax: 30.0,    // ì •ìƒ: 26.0 ~ 30.0
      warning2Min: 31.0,  warning2Max: 31.0,  // ê²½ê³ : 31.0 (ë†’ìŒ)
      min: 24.77, max: 31.0 // ì •ê·œí™” ë²”ìœ„
    },
    // ì—¼ë„ (ppt)
    {
      warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ (ì œê±°)
      normalMin: 0.5,     normalMax: 45.0,    // ì •ìƒ: 0.5 ~ 45.0
      warning2Min: 46.0,  warning2Max: 47.0,  // ê²½ê³ : 46.0 ~ 47.0 (ë†’ìŒ)
      min: 0.5, max: 47.0  // ì •ê·œí™” ë²”ìœ„
    },
    // ì•”ëª¨ë‹ˆì•„ (ppm)
    {
      warning1Min: null,  warning1Max: null,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ (ì œê±°)
      normalMin: 0.0,     normalMax: 0.16,    // ì •ìƒ: 0.0 ~ 0.16
      warning2Min: 0.3,   warning2Max: 0.5,   // ê²½ê³ : 0.3 ~ 0.5 (ë†’ìŒ)
      min: 0.0, max: 0.5   // ì •ê·œí™” ë²”ìœ„
    },
    // ì•„ì§ˆì‚° (ppm)
    {
      warning1Min: 0.0001,  warning1Max: 0.09,  // ë‚®ìŒ ê²½ê³  ì—†ìŒ (ì œê±°)
      normalMin: 0.0,     normalMax: 5.0,     // ì •ìƒ: 0.0 ~ 5.0
      warning2Min: 5.1,   warning2Max: 5.2,   // ê²½ê³ : 5.1 ~ 5.2 (ë†’ìŒ)
      min: 0.0001, max: 5.2   // ì •ê·œí™” ë²”ìœ„
    }
  ];

  // ìƒ‰ìƒ ê²°ì • í•¨ìˆ˜ (ê²½ê³  â†’ ì •ìƒ â†’ ê²½ê³ )
  const getColor = (value, range) => {
    // null ê°’ì„ ì •ìƒ ë²”ìœ„ ì¤‘ê°„ ê°’ìœ¼ë¡œ ì²˜ë¦¬
    if (value === null) {
      value = (range.normalMin + range.normalMax) / 2;
    }

    if (range.warning1Min !== null && range.warning1Max !== null && value >= range.warning1Min && value <= range.warning1Max) {
      return { background: '#ff4500', border: '#ff7f7f', status: 'warning' }; // ê²½ê³  (ë‚®ìŒ)
    }
    if (value >= range.normalMin && value <= range.normalMax) {
      return { background: '#32cd32', border: '#90ee90', status: 'normal' }; // ì •ìƒ
    }
    if (range.warning2Min !== null && range.warning2Max !== null && value >= range.warning2Min && value <= range.warning2Max) {
      return { background: '#ff4500', border: '#ff7f7f', status: 'warning' }; // ê²½ê³  (ë†’ìŒ)
    }
    return { background: '#ff4500', border: '#ff7f7f', status: 'warning' }; // ë²”ìœ„ ë°–ì€ ê²½ê³ ë¡œ ì²˜ë¦¬
  };

  // ìƒ‰ìƒ ë°°ì—´ ìƒì„± ë° ê²½ê³  ìƒíƒœ í™•ì¸
  const backgroundColors = [];
  const borderColors = [];
  let hasWarning = false; // ê²½ê³  ìƒíƒœê°€ ìˆëŠ”ì§€ í™•ì¸

  dataValues.forEach((value, index) => {
    const colors = getColor(value, ranges[index]);
    backgroundColors.push(colors.background);
    borderColors.push(colors.border);
    if (colors.status === 'warning') {
      hasWarning = true; // ê²½ê³  ìƒíƒœê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ true
    }
  });

  // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
  console.log(`Tank ${tank.tankIdx} - Has Warning: ${hasWarning}`);

  // tank-infoì— ê¹œë¹¡ì´ëŠ” íš¨ê³¼ ì ìš©
  if (hasWarning) {
    tankInfo.classList.add('blink-tank-info');
  } else {
    tankInfo.classList.remove('blink-tank-info');
  }

  // í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë™ê¸°í™”
  const textElements = [
    document.getElementById(`ph-${tank.tankIdx}`),
    document.getElementById(`do-${tank.tankIdx}`),
    document.getElementById(`temp-${tank.tankIdx}`),
    document.getElementById(`salt-${tank.tankIdx}`),
    document.getElementById(`ammonia-${tank.tankIdx}`),
    document.getElementById(`nitrogen-${tank.tankIdx}`)
  ];

  dataValues.forEach((value, index) => {
    const colors = getColor(value, ranges[index]);
    textElements[index].style.color = colors.border;
  });

  // ì°¨íŠ¸ ìƒì„±
  chartInstances[canvasId] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['ì‚°ì„±ë„', 'ìš©ì¡´ì‚°ì†Œ', 'ìˆ˜ì˜¨', 'ì—¼ë„', 'ì•”ëª¨ë‹ˆì•„', 'ì•„ì§ˆì‚°'],
      datasets: [{
        label: `${tank.tankIdx}ë²ˆ ìˆ˜ì¡° ë°ì´í„°`,
        data: [
          normalize(latestData.waterPh, ranges[0].min, ranges[0].max),
          normalize(latestData.waterDo, ranges[1].min, ranges[1].max),
          normalize(latestData.waterTemp, ranges[2].min, ranges[2].max),
          normalize(latestData.waterSalt, ranges[3].min, ranges[3].max),
          normalize(latestData.waterAmmonia, ranges[4].min, ranges[4].max),
          normalize(latestData.waterNitrogen, ranges[5].min, ranges[5].max)
        ],
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 1,
        barThickness: 23,
        categoryPercentage: 0.9,
        barPercentage: 0.95
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: false,
      maintainAspectRatio: false,
      layout: { padding: { left: 0, right: 0, top: 0, bottom: 0 } },
      scales: {
        x: { beginAtZero: true, display: false },
        y: { display: true, ticks: { font: { size: 13 }, padding: 2, color: '#ffffff' } }
      },
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      animation: { duration: 1000*60*60*24, easing: 'easeInOutQuad' }
    }
  });
}

// ì •ê·œí™” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
function normalize(value, min, max) {
  if (max === min) return 0;
  return (value - min) / (max - min);
}

      // ìˆ˜ì¡° ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
      function editTank(tankIdx) {
        console.log(`ğŸš€ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™: tankIdx=${tankIdx}`);
        window.location.href = `/tank/edit/${tankIdx}`;
      }

      // ìˆ˜ì¡° ì‚­ì œ í•¨ìˆ˜
      async function deleteTank(tankIdx) {
        console.log(`ğŸš€ ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨: tankIdx=${tankIdx}`);
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
          let response = await fetch(`/tank/delete/${tankIdx}`, { method: "PUT" });
          if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
          alert("âœ… ìˆ˜ì¡° ì‚­ì œ ì™„ë£Œ!");
          document.getElementById(`tank-${tankIdx}`).remove();
        } catch (error) {
          console.error("âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          alert("âŒ ì‚­ì œ ì‹¤íŒ¨!");
        }
      }

      // ìˆ˜ì¡° ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
      function goToDashboardDetail(tankIdx) {
        console.log(`ğŸš€ ìˆ˜ì¡° ìƒì„¸ í˜ì´ì§€ ì´ë™: tankIdx=${tankIdx}`);
        window.location.href = `/dashboarddetail?tankIdx=${tankIdx}`;
      }

      // ì•ŒëŒ ë°ì´í„° ì—…ë°ì´íŠ¸
      async function updateAlarmContent(tankIdx) {
        try {
          let alarms = [
            { "timestamp": "2025-03-18T15:03:00", "message": "ìš©ì¡´ì‚°ì†Œ 4mg/L", "status": "critical" },
            { "timestamp": "2025-03-18T15:00:00", "message": "ì—¼ë„ ì´ìƒ", "status": "warning" },
            { "timestamp": "2025-03-18T14:55:00", "message": "ì•”ëª¨ë‹ˆì•„ 0.5ppm", "status": "critical" },
            { "timestamp": "2025-03-18T14:50:00", "message": "ìˆ˜ì˜¨ ì´ìƒ", "status": "warning" }
          ];
          console.log(`âœ… í…ŒìŠ¤íŠ¸ ì•ŒëŒ ë°ì´í„° (tankIdx=${tankIdx}):`, alarms);

          let alarmContent = document.getElementById(`alarm-content-${tankIdx}`);
          let alarmContainer = document.getElementById(`alarm-log-${tankIdx}`);

          alarms.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const latestAlarm = alarms[0];
          alarmContent.innerHTML = `
            <div class="alarm-item">
              ${new Date(latestAlarm.timestamp).toLocaleTimeString()} - ${latestAlarm.message} (${latestAlarm.status === "critical" ? "ìœ„í—˜" : "ê²½ê³ "})
            </div>
          `;

          alarmContainer.addEventListener("mouseenter", () => {
            const latestFourAlarms = alarms.slice(0, 4);
            alarmContent.innerHTML = latestFourAlarms
              .map(alarm => `
                <div class="alarm-item">
                  ${new Date(alarm.timestamp).toLocaleTimeString()} - ${alarm.message} (${alarm.status === "critical" ? "ìœ„í—˜" : "ê²½ê³ "})
                </div>
              `)
              .join("");
          });

          alarmContainer.addEventListener("mouseleave", () => {
            alarmContent.innerHTML = `
              <div class="alarm-item">
                ${new Date(latestAlarm.timestamp).toLocaleTimeString()} - ${latestAlarm.message} (${latestAlarm.status === "critical" ? "ìœ„í—˜" : "ê²½ê³ "})
              </div>
            `;
          });

          alarmContent.addEventListener("click", () => {
            window.location.href = "/alarmHistory";
          });
        } catch (error) {
          console.error(`âŒ ì•ŒëŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (tankIdx=${tankIdx}):`, error);
          alarmContent.innerHTML = "ì•ŒëŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        }
      }

      // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
      function startUpdates(tankIds) {
        console.log("â³ ìë™ ê°±ì‹  ì‹œì‘:", tankIds);
        tankIds.forEach(tankIdx => {
          updateTankData(tankIdx); // ì´ˆê¸° ë°ì´í„° ì—…ë°ì´íŠ¸
          updateAlarmContent(tankIdx); // ì´ˆê¸° ì•ŒëŒ ì—…ë°ì´íŠ¸
          setInterval(() => {
            updateTankData(tankIdx); // ìˆ˜ì¡° ë°ì´í„° ê°±ì‹ 
            updateAlarmContent(tankIdx); // ì•ŒëŒ ë¡œê·¸ ê°±ì‹ 
          }, 5000); // 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ë³€ê²½
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      window.onload = async function () {
        let userId = `[[${session.loginUser?.userId}]]`;
        
        // ìµœì´ˆ ìˆ˜ì¡° ë¡œë“œ ë° tankIds ë°˜í™˜
        const tankIds = await loadTanks(userId);
        
        // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
        startUpdates(tankIds);

        // ì„¸ì…˜ ìœ ì§€ ìš”ì²­ (5ë¶„ë§ˆë‹¤)
        setInterval(() => {
          fetch('/keep-session-alive', { method: 'GET', credentials: 'include' })
            .then(response => console.log('âœ… ì„¸ì…˜ ìœ ì§€ ìš”ì²­ ë³´ëƒ„'))
            .catch(error => console.error('âŒ ì„¸ì…˜ ìœ ì§€ ì‹¤íŒ¨', error));
        }, 5 * 60 * 1000);
      };
    </script>
  </body>
</html>